# fly.io configuration for dotdo stateless Durable Objects
# See: https://fly.io/docs/reference/configuration/

app = "dotdo"
primary_region = "iad"

[build]
  dockerfile = "Dockerfile"

[env]
  NODE_ENV = "production"
  # Port that the Node.js server listens on
  PORT = "8787"

[http_service]
  internal_port = 8787
  force_https = true
  auto_stop_machines = "suspend"
  auto_start_machines = true
  min_machines_running = 2
  processes = ["app"]

  [http_service.concurrency]
    type = "connections"
    hard_limit = 250
    soft_limit = 200

  [http_service.http_options]
    h2_backend = true

[[vm]]
  size = "shared-cpu-1x"
  memory = "512mb"
  cpu_kind = "shared"
  cpus = 1

[checks]
  [checks.health]
    grace_period = "10s"
    interval = "30s"
    method = "GET"
    path = "/api/health"
    timeout = "5s"
    type = "http"

[metrics]
  port = 9091
  path = "/metrics"

# Multi-region deployment for global edge
# Deploy to multiple regions for low latency worldwide
# iad = Ashburn, Virginia (US East)
# lhr = London (Europe)
# nrt = Tokyo (Asia)
# syd = Sydney (Australia)
#
# Scale with: fly scale count 2 --region iad,lhr,nrt,syd

# Secrets (set via fly secrets set)
# Required:
#   TURSO_URL        - LibSQL/Turso database URL
#   TURSO_TOKEN      - Turso authentication token
#
# Optional (for R2 storage):
#   R2_ACCESS_KEY    - Cloudflare R2 access key
#   R2_SECRET_KEY    - Cloudflare R2 secret key
#   R2_ENDPOINT      - R2 endpoint URL
#
# Optional (for AI features):
#   OPENAI_API_KEY   - OpenAI API key
#   ANTHROPIC_API_KEY - Anthropic API key

[experimental]
  allowed_public_ports = []
  auto_rollback = true

[deploy]
  release_command = "node dist/migrate.js"
  strategy = "rolling"
