# =============================================================================
# dotdo - Development Dockerfile
# Hot reload enabled for rapid iteration
# =============================================================================

FROM node:22-alpine

WORKDIR /app

# Install development tools
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    git \
    wget \
    ca-certificates \
    bash \
    curl \
    && rm -rf /var/cache/apk/*

# Install pnpm globally
RUN npm install -g pnpm@9

# Create non-root user (optional for dev, but good practice)
RUN addgroup -g 1001 -S dotdo && \
    adduser -S dotdo -u 1001 -G dotdo

# Copy package files first for better layer caching
COPY package.json pnpm-lock.yaml ./
COPY packages ./packages

# Install all dependencies (including devDependencies)
RUN pnpm install --frozen-lockfile

# Copy source code (will be overwritten by volume mount)
COPY . .

# Create data directory
RUN mkdir -p /app/data && chown -R dotdo:dotdo /app

# Environment variables for development
ENV NODE_ENV=development \
    PORT=8787 \
    # External state - defaults for local development
    TURSO_URL=http://turso-local:8080 \
    TURSO_TOKEN="" \
    # R2/MinIO for local S3-compatible storage
    R2_ENDPOINT=http://minio:9000 \
    R2_ACCESS_KEY_ID=minioadmin \
    R2_SECRET_ACCESS_KEY=minioadmin \
    R2_BUCKET=dotdo-iceberg \
    # Development settings
    LOG_LEVEL=debug \
    WRANGLER_LOG=debug

# Expose ports
EXPOSE 8787

# Health check
HEALTHCHECK --interval=10s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8787/health || exit 1

# Start in development mode with hot reload
CMD ["pnpm", "run", "dev", "--", "--port", "8787", "--ip", "0.0.0.0"]
