# Fly.io values for dotdo
# Fly.io runs containers directly, this is for reference or hybrid deployments
# Use: helm install dotdo ./deploy/helm/dotdo -f values-fly.yaml

replicaCount: 3

image:
  repository: registry.fly.io/dotdo
  pullPolicy: Always

env:
  NODE_ENV: production
  LOG_LEVEL: info
  # Fly.io specific
  FLY_REGION: "{{ .Values.flyRegion | default \"iad\" }}"
  FLY_APP_NAME: "dotdo"
  # Fly Postgres or external Turso
  TURSO_URL: ""
  # Fly.io Tigris (S3-compatible)
  R2_ENDPOINT: "https://fly.storage.tigris.dev"
  R2_BUCKET: "dotdo"
  # Upstash Redis for cross-pod communication
  REDIS_URL: ""

# Fly.io typically uses direct networking
service:
  type: ClusterIP
  port: 8787
  annotations:
    # Fly.io internal load balancing
    fly.io/internal: "true"

# Fly uses its own ingress/routing
ingress:
  enabled: false

# Resource limits appropriate for Fly machines
resources:
  limits:
    cpu: 2000m
    memory: 1Gi
  requests:
    cpu: 256m
    memory: 256Mi

# Fly.io autoscaling via fly.toml, minimal HPA
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 50
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Fly machines have fast cold starts
livenessProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 3
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Fly.io region-based affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - dotdo
          topologyKey: fly.io/region

# Fly doesn't use Linkerd typically
linkerd:
  enabled: false

# Fly has its own metrics
prometheus:
  enabled: false

# Fly-specific annotations
podAnnotations:
  fly.io/regions: "iad,lax,fra,sin"
  fly.io/machines: "true"

# Network policy not typically used with Fly
networkPolicy:
  enabled: false

# Additional Fly.io specific values
flyRegion: "iad"
flyMachineSize: "shared-cpu-2x"
