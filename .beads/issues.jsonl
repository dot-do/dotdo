{"id":"do-0mp","title":"[GREEN] Extend nouns schema with replica config","description":"Extend the nouns schema to pass the RED tests for replica configuration.\n\n## Implementation\n- Add fields to db/nouns.ts:\n  - replicaCount: integer (default: 0)\n  - consistencyMode: text (default: 'strong')\n  - regions: text JSON (default: null)\n  - primaryRegion: text (default: null)\n  - readPreference: text (default: 'primary')\n- Generate migration with drizzle-kit\n- Update migrations.ts to include new migration\n\n## Files\n- `db/nouns.ts`\n- `db/drizzle/migrations.ts`\n- `db/drizzle/0002_*.sql`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T06:29:44.364443-06:00","updated_at":"2026-01-14T06:29:44.364443-06:00","labels":["db","green","schema","tdd"],"dependencies":[{"issue_id":"do-0mp","depends_on_id":"do-224","type":"blocks","created_at":"2026-01-14T06:31:57.998193-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-0rx","title":"[RED] Test: Location extraction from CF request","description":"Write failing tests for extracting location data from Cloudflare request metadata.\n\n## Test Cases\n- Extract colo code from request.cf.colo\n- Extract region from request.cf.region\n- Extract coordinates from request.cf.latitude/longitude\n- Handle missing CF metadata gracefully\n- Extract continent for broad region matching\n\n## Files\n- `api/tests/location.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T06:29:13.17605-06:00","updated_at":"2026-01-14T06:29:13.17605-06:00","labels":["api","red","tdd","testing"]}
{"id":"do-224","title":"[RED] Test: Nouns schema replica fields","description":"Write failing tests for the extended nouns schema with replica configuration.\n\n## Test Cases\n- Validate replicaCount field (0-10)\n- Validate consistencyMode enum ('strong' | 'eventual' | 'causal')\n- Validate regions JSON array\n- Validate primaryRegion field\n- Validate readPreference enum\n- Test migration adds new columns\n\n## Files\n- `db/tests/nouns-replica.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T06:29:13.916219-06:00","updated_at":"2026-01-14T06:29:13.916219-06:00","labels":["db","red","tdd","testing"]}
{"id":"do-2kf","title":"[REFACTOR] Consolidate API routing logic","description":"Refactor API routing to consolidate scattered logic.\n\n## Refactoring\n- Move all routing logic to `api/routing/` directory\n- Create `api/routing/index.ts` as single entry point\n- Extract: location.ts, replica-selector.ts, consistency.ts, url-normalize.ts\n- Update api/index.ts to use consolidated routing module\n- Remove dead code (unused getReplicaAwareBinding)\n\n## Files\n- `api/routing/*.ts`\n- `api/index.ts`","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-14T06:30:10.175244-06:00","updated_at":"2026-01-14T06:30:10.175244-06:00","labels":["api","refactor","tdd"]}
{"id":"do-3jm","title":"[RED] Test: Flexible REST lookup by ID or name","description":"Write failing tests for flexible REST lookups that support both ID and name.\n\n## Test Cases\n- GET /customers/cust-123 → lookup by $id\n- GET /customers/Alice → lookup by name field\n- GET /customers/alice@example.com → lookup by email field\n- Disambiguation when value could match multiple fields\n- Case-insensitive name matching option\n- 404 when neither ID nor name match\n\n## Files\n- `api/tests/flexible-lookup.test.ts`\n- `objects/transport/tests/rest-lookup.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T06:29:42.923086-06:00","updated_at":"2026-01-14T06:29:42.923086-06:00","labels":["api","red","rest","tdd"]}
{"id":"do-4n0","title":"[RED] Test: Consistency mode routing","description":"Write failing tests for consistency mode handling in routing.\n\n## Test Cases\n- Strong consistency: Always route to primary\n- Eventual consistency: Route reads to nearest replica\n- Causal consistency: Session-sticky routing\n- Write requests always go to primary regardless of mode\n- Consistency mode from noun config\n\n## Files\n- `api/tests/consistency-modes.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T06:29:15.257597-06:00","updated_at":"2026-01-14T06:29:15.257597-06:00","labels":["api","red","tdd","testing"]}
{"id":"do-590","title":"[RED] Test: URL path underscore/space handling","description":"Write failing tests for underscore to space conversion in URL paths.\n\n## Test Cases\n- GET /customers/John_Doe → matches \"John Doe\"\n- GET /customers/john_doe → matches \"john doe\" or \"John Doe\" (case insensitive)\n- GET /customers/John%20Doe → matches \"John Doe\" (URL encoded space)\n- Multiple underscores: New_York_City → \"New York City\"\n- Mixed: San_Francisco-CA → \"San Francisco-CA\" (only _ converted)\n\n## Files\n- `api/tests/url-normalization.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T06:30:08.775629-06:00","updated_at":"2026-01-14T06:30:08.775629-06:00","labels":["api","red","tdd"]}
{"id":"do-d5y","title":"[RED] Test: getDOBinding with replica support","description":"Write failing tests for the updated getDOBinding function with replica support.\n\n## Test Cases\n- Returns replica binding for read requests when replicas configured\n- Returns primary binding for write requests\n- Returns nounConfig.replicaCount in response\n- Uses locationHint for DO stub creation\n- Integrates with existing static routes\n\n## Files\n- `api/tests/do-binding-replicas.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T06:29:15.880693-06:00","updated_at":"2026-01-14T06:29:15.880693-06:00","labels":["api","red","tdd","testing"]}
{"id":"do-dis","title":"[GREEN] Implement nearest replica selection","description":"Implement the nearest replica selection algorithm to pass RED tests.\n\n## Implementation\n- Create `api/replica-selector.ts` with:\n  - `selectNearestReplica(location, regions)` → region\n  - `haversineDistance(lat1, lng1, lat2, lng2)` → km\n  - `buildReplicaNamespace(tenant, region)` → string\n- Use region coordinates for distance calculation\n- Fallback chain: same-colo → same-region → nearest-region → primary\n\n## Files\n- `api/replica-selector.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T06:29:45.076958-06:00","updated_at":"2026-01-14T06:29:45.076958-06:00","labels":["api","green","tdd"],"dependencies":[{"issue_id":"do-dis","depends_on_id":"do-pd9","type":"blocks","created_at":"2026-01-14T06:31:57.159633-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ex2","title":"[GREEN] Implement location extraction utility","description":"Implement the location extraction utility to pass the RED tests.\n\n## Implementation\n- Create `api/location.ts` with:\n  - `extractLocation(request)` → { colo, region, continent, lat, lng }\n  - `coloToRegion(colo)` → region mapping\n  - `getRegionCoordinates(region)` → { lat, lng }\n- Handle missing CF metadata gracefully\n- Export types for LocationInfo\n\n## Files\n- `api/location.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T06:29:43.658848-06:00","updated_at":"2026-01-14T06:29:43.658848-06:00","labels":["api","green","tdd"],"dependencies":[{"issue_id":"do-ex2","depends_on_id":"do-0rx","type":"blocks","created_at":"2026-01-14T06:31:58.713109-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi","title":"dotdo Core Runtime - Minimal Viable DO","description":"Build the minimal viable Durable Object runtime with:\n- Basic DO with SQLite storage (Things, Relationships, Events, Actions)\n- Simple Hono passthrough worker\n- Cap'n Web RPC support\n- MCP transport","status":"open","priority":0,"issue_type":"epic","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:27.391552-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T05:43:14.146646-06:00","external_ref":"gh-61","labels":["core","mvp","runtime"]}
{"id":"do-ifi.1","title":"DO Storage Layer - Things, Relationships, Events, Actions","description":"Core SQLite-backed storage with the 4 base types","status":"open","priority":1,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:36.217605-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T05:43:14.147494-06:00","external_ref":"gh-62","labels":["core","storage"],"dependencies":[{"issue_id":"do-ifi.1","depends_on_id":"do-ifi","type":"parent-child","created_at":"2026-01-14T04:43:36.218273-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi.1.1","title":"Things store - CRUD operations","status":"open","priority":1,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:45.128787-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T05:43:14.148059-06:00","external_ref":"gh-63","labels":["storage","things"],"dependencies":[{"issue_id":"do-ifi.1.1","depends_on_id":"do-ifi.1","type":"parent-child","created_at":"2026-01-14T04:43:45.129653-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi.1.2","title":"Relationships store - Graph edges","status":"open","priority":1,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:45.239076-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T04:43:45.239076-06:00","labels":["relationships","storage"],"dependencies":[{"issue_id":"do-ifi.1.2","depends_on_id":"do-ifi.1","type":"parent-child","created_at":"2026-01-14T04:43:45.239684-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi.1.3","title":"Events store - Immutable event log","status":"open","priority":1,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:45.345538-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T04:43:45.345538-06:00","labels":["events","storage"],"dependencies":[{"issue_id":"do-ifi.1.3","depends_on_id":"do-ifi.1","type":"parent-child","created_at":"2026-01-14T04:43:45.346323-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi.1.4","title":"Actions store - Durable task queue","status":"open","priority":1,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:45.452623-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T04:43:45.452623-06:00","labels":["actions","storage"],"dependencies":[{"issue_id":"do-ifi.1.4","depends_on_id":"do-ifi.1","type":"parent-child","created_at":"2026-01-14T04:43:45.453249-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi.2","title":"Hono Worker Passthrough","description":"Simple worker that proxies all requests to DO.fetch()","status":"open","priority":1,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:36.32908-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T04:43:36.32908-06:00","labels":["routing","worker"],"dependencies":[{"issue_id":"do-ifi.2","depends_on_id":"do-ifi","type":"parent-child","created_at":"2026-01-14T04:43:36.329619-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi.3","title":"Cap'n Web RPC Integration","description":"Promise pipelining with capnweb","status":"open","priority":1,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:36.438315-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T05:43:14.148584-06:00","external_ref":"gh-68","labels":["capnweb","rpc"],"dependencies":[{"issue_id":"do-ifi.3","depends_on_id":"do-ifi","type":"parent-child","created_at":"2026-01-14T04:43:36.438932-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ifi.4","title":"MCP Transport","description":"Model Context Protocol transport for AI integration","status":"open","priority":2,"issue_type":"task","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T04:43:36.552469-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T05:43:14.149115-06:00","external_ref":"gh-69","labels":["ai","mcp"],"dependencies":[{"issue_id":"do-ifi.4","depends_on_id":"do-ifi","type":"parent-child","created_at":"2026-01-14T04:43:36.55304-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ip9","title":"[GREEN] Update getDOBinding for replicas","description":"Update getDOBinding function to integrate replica routing.\n\n## Implementation\n- Accept request object (not just pathname/hostname)\n- Extract location from request\n- Check noun config for replica settings\n- Use selectNearestReplica for read requests\n- Add locationHint when creating DO stub\n- Return replica info in response\n\n## Files\n- `api/index.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T06:29:46.450434-06:00","updated_at":"2026-01-14T06:29:46.450434-06:00","labels":["api","green","tdd"],"dependencies":[{"issue_id":"do-ip9","depends_on_id":"do-d5y","type":"blocks","created_at":"2026-01-14T06:31:55.713498-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-lqk","title":"[GREEN] Implement consistency mode router","description":"Implement consistency mode handling to pass RED tests.\n\n## Implementation\n- Create `api/consistency.ts` with:\n  - `shouldRouteToReplica(method, consistencyMode, sessionId)` → boolean\n  - `getSessionStickyReplica(sessionId, regions)` → region\n- Integrate into getDOBinding()\n- Support session affinity via header or cookie\n\n## Files\n- `api/consistency.ts`\n- `api/index.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T06:29:45.770493-06:00","updated_at":"2026-01-14T06:29:45.770493-06:00","labels":["api","green","tdd"],"dependencies":[{"issue_id":"do-lqk","depends_on_id":"do-4n0","type":"blocks","created_at":"2026-01-14T06:31:56.522805-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-nov","title":"Epic: Location-Aware Replica Routing","description":"Implement location-aware routing for read replicas in the API layer. This enables low-latency reads by routing to the nearest replica while maintaining consistency guarantees.\n\n## Goals\n- Extract location from Cloudflare request metadata\n- Extend nouns schema with replica configuration\n- Implement nearest-replica selection algorithm\n- Support multiple consistency modes (strong, eventual, causal)\n- Integrate replica routing into getDOBinding()\n\n## Architecture\n- Primary DO handles all writes\n- Read replicas handle read traffic based on consistency mode\n- Location hints guide CF to prefer certain regions\n- Nouns table defines per-collection replica strategy","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-14T06:28:55.522396-06:00","updated_at":"2026-01-14T06:28:55.522396-06:00","labels":["api","replicas","routing"]}
{"id":"do-pd9","title":"[RED] Test: Nearest replica selection algorithm","description":"Write failing tests for the nearest replica selection algorithm.\n\n## Test Cases\n- Select replica in same region as request\n- Select nearest region when no exact match\n- Haversine distance calculation for coordinates\n- Fallback to primary when no replicas available\n- Handle colo-to-region mapping\n\n## Files\n- `api/tests/replica-selection.test.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T06:29:14.587664-06:00","updated_at":"2026-01-14T06:29:14.587664-06:00","labels":["api","red","tdd","testing"]}
{"id":"do-r9w","title":"Replace manual schema-init.ts with Drizzle Kit migrations","description":"Current `db/schema-init.ts` uses raw SQL CREATE TABLE statements. Should use Drizzle Kit migrations per https://orm.drizzle.team/docs/connect-cloudflare-do\n\nTasks:\n1. Add drizzle.config.ts for sqlite-core with DO settings\n2. Generate migrations from existing Drizzle schemas (schema-minimal.ts, etc.)\n3. Replace initSchema() with migrate() from drizzle-orm/durable-sqlite/migrator\n4. Use blockConcurrencyWhile() for safe migration application\n5. Delete db/schema-init.ts after migration\n\nBenefits:\n- Single source of truth (TypeScript schemas)\n- Proper versioned migrations\n- ALTER TABLE support for schema evolution\n- Better DX with drizzle-kit push/generate","status":"closed","priority":2,"issue_type":"task","assignee":"subagent","owner":"4130910+nathanclevenger@users.noreply.github.com","created_at":"2026-01-14T05:30:22.576857-06:00","created_by":"Nathan Clevenger","updated_at":"2026-01-14T05:39:25.818385-06:00","closed_at":"2026-01-14T05:39:25.818385-06:00","close_reason":"Implemented Drizzle Kit migrations in 3 commits"}
{"id":"do-rpz","title":"[GREEN] Implement URL path normalization","description":"Implement URL path normalization for underscore/space handling.\n\n## Implementation\n- Create `api/url-normalize.ts`:\n  - `normalizePathSegment(segment)` → normalized string\n  - `generateSearchVariants(segment)` → array of variants to try\n- Update rest-router.ts to use normalization\n- Support both _ and %20 as space alternatives\n\n## Files\n- `api/url-normalize.ts`\n- `objects/transport/rest-router.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T06:30:09.491505-06:00","updated_at":"2026-01-14T06:30:09.491505-06:00","labels":["api","green","tdd"],"dependencies":[{"issue_id":"do-rpz","depends_on_id":"do-590","type":"blocks","created_at":"2026-01-14T06:31:54.295522-06:00","created_by":"Nathan Clevenger"}]}
{"id":"do-ssm","title":"[REFACTOR] Simplify /query endpoint to use noun config","description":"Refactor /query endpoint to automatically use noun config for sharding.\n\n## Current Problem\nUser must provide shardConfig in request body - too complex.\n\n## Solution\n- Read shardConfig from noun config automatically\n- Simplify request to just: { collection, filter, sort, limit }\n- Auto-detect if collection is sharded from nouns table\n- Remove manual shardConfig from API\n\n## Files\n- `api/index.ts`","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-14T06:30:11.585402-06:00","updated_at":"2026-01-14T06:30:11.585402-06:00","labels":["api","refactor","tdd"]}
{"id":"do-tic","title":"[REFACTOR] Add routing observability","description":"Add observability for routing decisions.\n\n## Implementation\n- Log routing decisions with structured data\n- Add X-Routing-Info header to responses:\n  - X-DO-Namespace\n  - X-Replica-Region (if applicable)\n  - X-Consistency-Mode\n  - X-Location-Colo\n- Expose /api/routing/debug endpoint (dev only)\n\n## Files\n- `api/routing/observability.ts`\n- `api/index.ts`","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-14T06:30:10.947011-06:00","updated_at":"2026-01-14T06:30:10.947011-06:00","labels":["api","observability","refactor","tdd"]}
{"id":"do-yye","title":"[GREEN] Implement flexible REST lookup","description":"Implement flexible REST lookup to support both ID and name.\n\n## Implementation\n- Update rest-router.ts handleGetOne:\n  - First try exact $id match\n  - Then try name field match\n  - Then try other indexed fields\n- Add lookup strategy to noun config (optional)\n- Support case-insensitive matching option\n\n## Files\n- `objects/transport/rest-router.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T06:29:47.113533-06:00","updated_at":"2026-01-14T06:29:47.113533-06:00","labels":["api","green","rest","tdd"],"dependencies":[{"issue_id":"do-yye","depends_on_id":"do-3jm","type":"blocks","created_at":"2026-01-14T06:31:55.01495-06:00","created_by":"Nathan Clevenger"}]}
