# dotdo Worker Configuration
# See https://developers.cloudflare.com/workers/configuration/

name = "dotdo"
main = "api/index.ts"
compatibility_date = "2026-01-08"
compatibility_flags = ["nodejs_compat"]

# ============================================================================
# STATIC ASSETS
# See https://developers.cloudflare.com/workers/static-assets/
# ============================================================================
[assets]
directory = "./dist"
binding = "ASSETS"

# HTML handling: auto-trailing-slash (default)
# - Individual files (e.g. foo.html) served without trailing slash
# - Folder index files (e.g. foo/index.html) served with trailing slash
# - Helps SEO by avoiding duplicate content issues
html_handling = "auto-trailing-slash"

# SPA mode: unknown paths return index.html for client-side routing
not_found_handling = "single-page-application"

# Dynamic routes that bypass static assets and invoke the Worker
# Static routes (/, /docs/*, /admin/*) are served directly from ./dist
run_worker_first = ["/api/*", "/mcp", "/rpc/*"]

# ============================================================================
# KV NAMESPACES
# See https://developers.cloudflare.com/kv/
# ============================================================================
[[kv_namespaces]]
binding = "KV"
id = "placeholder-kv-id"

# ============================================================================
# R2 OBJECT STORAGE
# See https://developers.cloudflare.com/r2/
# ============================================================================
[[r2_buckets]]
binding = "R2"
bucket_name = "dotdo-storage"

# ============================================================================
# D1 DATABASE
# See https://developers.cloudflare.com/d1/
# ============================================================================
[[d1_databases]]
binding = "DB"
database_name = "dotdo"
database_id = "placeholder-d1-id"

# ============================================================================
# DURABLE OBJECTS
# See https://developers.cloudflare.com/durable-objects/
# ============================================================================
[durable_objects]
bindings = [
  { name = "DO", class_name = "ThingsDO" },
  { name = "WORKFLOW_DO", class_name = "Workflow" },
  { name = "INTEGRATIONS_DO", class_name = "IntegrationsDO" },
  { name = "SANDBOX_DO", class_name = "SandboxDO" },
]

# DO Migrations
[[migrations]]
tag = "v1"
new_classes = ["DurableObject", "TestDurableObject"]

[[migrations]]
tag = "v3"
renamed_classes = [{ from = "DurableObject", to = "ThingsDO" }]

[[migrations]]
tag = "v4"
new_classes = ["Workflow", "IntegrationsDO", "SandboxDO"]

# ============================================================================
# QUEUES - Async Job Processing
# See https://developers.cloudflare.com/queues/
# Queue operations are handled by lib/cloudflare/queues.ts
# ============================================================================

# Events Queue - Domain event delivery to external systems
[[queues.producers]]
binding = "EVENTS_QUEUE"
queue = "dotdo-events"

[[queues.consumers]]
queue = "dotdo-events"
max_batch_size = 50
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "dotdo-dlq"

# Jobs Queue - Background task processing (emails, reports, etc.)
[[queues.producers]]
binding = "JOBS_QUEUE"
queue = "dotdo-jobs"

[[queues.consumers]]
queue = "dotdo-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 5
dead_letter_queue = "dotdo-dlq"

# Webhooks Queue - External webhook delivery with extended retries
[[queues.producers]]
binding = "WEBHOOKS_QUEUE"
queue = "dotdo-webhooks"

[[queues.consumers]]
queue = "dotdo-webhooks"
max_batch_size = 5
max_batch_timeout = 30
max_retries = 5
dead_letter_queue = "dotdo-dlq"

# Dead Letter Queue - Failed message storage for analysis/replay
[[queues.producers]]
binding = "DLQ_QUEUE"
queue = "dotdo-dlq"

[[queues.consumers]]
queue = "dotdo-dlq"
max_batch_size = 10
max_batch_timeout = 60
max_retries = 0

# ============================================================================
# AI BINDINGS
# See https://developers.cloudflare.com/workers-ai/
# ============================================================================
[ai]
binding = "AI"

# ============================================================================
# VECTORIZE
# See https://developers.cloudflare.com/vectorize/
# ============================================================================
[[vectorize]]
binding = "VECTORS"
index_name = "dotdo-things"

# ============================================================================
# WORKFLOWS
# See https://developers.cloudflare.com/workflows/
# ============================================================================
[[workflows]]
name = "dotdo-workflow"
binding = "WORKFLOW"
class_name = "WorkflowRuntime"

# ============================================================================
# HYPERDRIVE (PostgreSQL Acceleration)
# See https://developers.cloudflare.com/hyperdrive/
# ============================================================================
[[hyperdrive]]
binding = "HYPERDRIVE"
id = "placeholder-hyperdrive-id"

# ============================================================================
# BROWSER RENDERING
# See https://developers.cloudflare.com/browser-rendering/
# ============================================================================
[browser]
binding = "BROWSER"

# ============================================================================
# ANALYTICS ENGINE
# See https://developers.cloudflare.com/analytics/analytics-engine/
# ============================================================================
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "dotdo_events"

# ============================================================================
# ENVIRONMENT: STAGING
# ============================================================================
[env.staging]
name = "dotdo-staging"

[[env.staging.kv_namespaces]]
binding = "KV"
id = "placeholder-staging-kv-id"

[[env.staging.r2_buckets]]
binding = "R2"
bucket_name = "dotdo-storage-staging"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "dotdo-staging"
database_id = "placeholder-staging-d1-id"

# Staging Queues
[[env.staging.queues.producers]]
binding = "EVENTS_QUEUE"
queue = "dotdo-events-staging"

[[env.staging.queues.consumers]]
queue = "dotdo-events-staging"
max_batch_size = 50
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "dotdo-dlq-staging"

[[env.staging.queues.producers]]
binding = "JOBS_QUEUE"
queue = "dotdo-jobs-staging"

[[env.staging.queues.consumers]]
queue = "dotdo-jobs-staging"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 5
dead_letter_queue = "dotdo-dlq-staging"

[[env.staging.queues.producers]]
binding = "WEBHOOKS_QUEUE"
queue = "dotdo-webhooks-staging"

[[env.staging.queues.consumers]]
queue = "dotdo-webhooks-staging"
max_batch_size = 5
max_batch_timeout = 30
max_retries = 5
dead_letter_queue = "dotdo-dlq-staging"

[[env.staging.queues.producers]]
binding = "DLQ_QUEUE"
queue = "dotdo-dlq-staging"

[[env.staging.queues.consumers]]
queue = "dotdo-dlq-staging"
max_batch_size = 10
max_batch_timeout = 60
max_retries = 0

[[env.staging.vectorize]]
binding = "VECTORS"
index_name = "dotdo-things-staging"

[[env.staging.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "dotdo_events_staging"

# ============================================================================
# ENVIRONMENT: PRODUCTION
# ============================================================================
[env.production]
name = "dotdo"

[[env.production.kv_namespaces]]
binding = "KV"
id = "placeholder-production-kv-id"

[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "dotdo-storage-production"

[[env.production.d1_databases]]
binding = "DB"
database_name = "dotdo-production"
database_id = "placeholder-production-d1-id"

[[env.production.queues.producers]]
binding = "QUEUE"
queue = "dotdo-events-production"

[[env.production.queues.consumers]]
queue = "dotdo-events-production"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "dotdo-events-production-dlq"

[[env.production.queues.producers]]
binding = "DLQ"
queue = "dotdo-events-production-dlq"

[[env.production.vectorize]]
binding = "VECTORS"
index_name = "dotdo-things-production"

[[env.production.hyperdrive]]
binding = "HYPERDRIVE"
id = "placeholder-production-hyperdrive-id"

[[env.production.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "dotdo_events_production"
