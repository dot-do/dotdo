---
title: stripe.do
description: Stripe on the Edge — A fully managed payment orchestration service running on Cloudflare Workers with smart routing and AI agent support.
---

# stripe.do

**Stripe on the Edge** — A managed payment orchestration service that runs on Cloudflare Workers, with smart routing, automatic retries, and native AI agent support.

```typescript
import { StripeClient } from 'stripe.do'

const client = new StripeClient('https://your-worker.workers.dev')
const db = client.db('payments')

// It's Stripe, but smarter
const customer = await client.customers.create({
  email: 'customer@example.com',
})

const subscription = await client.subscriptions.create({
  customer: customer.id,
  items: [{ price: 'price_xxx' }],
})
```

<Callout type="info">
Looking for a drop-in SDK replacement for testing? See [@dotdo/stripe](/docs/integrations/stripe/package) for an edge-compatible Stripe client with StripeLocal.
</Callout>

## Why stripe.do?

Traditional payment integrations require careful error handling, webhook management, and retry logic. stripe.do handles all of that by running directly on Cloudflare's edge network:

- **Zero Infrastructure** — No servers to manage, automatic scaling, global deployment
- **Smart Routing** — Intelligent request routing with automatic failover
- **Built-in Orchestration** — Durable workflows for complex payment flows
- **AI-Native** — Native support for AI agents and automated billing
- **Edge Performance** — Sub-100ms latency worldwide
- **Full Audit Trail** — Complete payment history with time-travel queries

## Features

### Core Payments

| Feature | Description |
|---------|-------------|
| **Customers** | Full CRUD, search, and customer portal management |
| **Subscriptions** | Create, update, cancel with automatic proration handling |
| **Payment Intents** | Confirmation flows, captures, incremental auth |
| **Invoices** | Automatic invoicing, PDF generation, payment collection |
| **Checkout Sessions** | Hosted checkout with full customization |
| **Refunds** | Full and partial refunds with policy enforcement |

### Payment Orchestration

| Feature | Description |
|---------|-------------|
| **Smart Retry** | Exponential backoff with configurable policies |
| **Idempotency** | Automatic request deduplication at the edge |
| **Failover** | Multi-provider routing (Stripe primary, fallback providers) |
| **Rate Limiting** | Intelligent rate limit handling with queuing |
| **Webhooks** | Edge-processed webhooks with guaranteed delivery |

### AI & Agents

| Feature | Description |
|---------|-------------|
| **MCP Protocol** | Model Context Protocol for AI agent billing operations |
| **Automated Billing** | AI-driven subscription management and upgrades |
| **Revenue Analytics** | Real-time MRR, churn, and cohort analysis |
| **Dunning Automation** | Intelligent failed payment recovery |

### Connectivity

| Feature | Description |
|---------|-------------|
| **HTTP/RPC** | JSON-RPC over HTTP with request batching |
| **WebSocket** | Real-time payment status updates |
| **Service Bindings** | Zero-latency Worker-to-Worker communication |
| **Webhooks** | Inbound webhook processing with signature verification |

## Installation

```bash
npm install stripe.do
```

## Quick Start

### Deploy to Cloudflare Workers

```typescript
// src/index.ts
import { StripeEntrypoint, StripeDatabase } from 'stripe.do'

export { StripeDatabase }
export default StripeEntrypoint
```

```jsonc
// wrangler.jsonc
{
  "name": "my-stripe.do",
  "main": "src/index.ts",
  "compatibility_date": "2025-01-01",
  "compatibility_flags": ["nodejs_compat"],
  "durable_objects": {
    "bindings": [{ "name": "STRIPE_DATABASE", "class_name": "StripeDatabase" }]
  },
  "migrations": [{ "tag": "v1", "new_sqlite_classes": ["StripeDatabase"] }],
  "vars": {
    "STRIPE_SECRET_KEY": "sk_live_xxx",
    "STRIPE_WEBHOOK_SECRET": "whsec_xxx"
  }
}
```

```bash
npx wrangler deploy
```

### Local Development

```bash
# Start local server
npx stripe.do serve --port 4242

# Test with Stripe CLI
stripe trigger payment_intent.succeeded --forward-to localhost:4242/webhooks
```

## Examples

### SaaS Subscription Flow

```typescript
import { StripeClient } from 'stripe.do'

const stripe = new StripeClient('https://your-worker.workers.dev')

// 1. Create customer on signup
async function createCustomer(email: string, name: string) {
  return stripe.customers.create({
    email,
    name,
    metadata: { source: 'web_signup' },
  })
}

// 2. Start subscription with smart checkout
async function subscribe(customerId: string, priceId: string) {
  const session = await stripe.checkout.sessions.create({
    customer: customerId,
    mode: 'subscription',
    line_items: [{ price: priceId, quantity: 1 }],
    success_url: 'https://app.example.com/success',
    cancel_url: 'https://app.example.com/pricing',
    subscription_data: {
      metadata: { plan: 'pro' },
    },
  })

  return { url: session.url }
}

// 3. Handle subscription changes
async function upgradeSubscription(subscriptionId: string, newPriceId: string) {
  const subscription = await stripe.subscriptions.retrieve(subscriptionId)

  return stripe.subscriptions.update(subscriptionId, {
    items: [
      { id: subscription.items.data[0].id, price: newPriceId },
    ],
    proration_behavior: 'create_prorations',
  })
}
```

### Webhook Processing

stripe.do processes webhooks at the edge with automatic signature verification:

```typescript
// Webhook handler is built-in, but you can customize
import { StripeWebhooks } from 'stripe.do'

const webhooks = new StripeWebhooks({
  secret: env.STRIPE_WEBHOOK_SECRET,
})

webhooks.on('customer.subscription.created', async (event) => {
  const subscription = event.data.object
  await activateSubscription(subscription.customer, subscription.id)
})

webhooks.on('customer.subscription.deleted', async (event) => {
  const subscription = event.data.object
  await deactivateSubscription(subscription.customer)
})

webhooks.on('invoice.payment_failed', async (event) => {
  const invoice = event.data.object
  await notifyPaymentFailure(invoice.customer, invoice.id)
})

webhooks.on('invoice.paid', async (event) => {
  const invoice = event.data.object
  await recordPayment(invoice.customer, invoice.amount_paid)
})
```

### AI Agent Billing

```typescript
import { createMcpServer, createAnthropicAdapter } from 'stripe.do/mcp'
import Anthropic from '@anthropic-ai/sdk'

const server = createMcpServer({ stripe })
const adapter = createAnthropicAdapter({ server })
await adapter.initialize()

const client = new Anthropic()
const response = await client.messages.create({
  model: 'claude-sonnet-4-20250514',
  tools: await adapter.getTools(),
  messages: [{
    role: 'user',
    content: 'Upgrade customer cus_xxx to the enterprise plan'
  }]
})
```

### Revenue Analytics

```typescript
// Built-in revenue analytics
const analytics = await stripe.analytics.revenue({
  period: 'month',
  metrics: ['mrr', 'arr', 'churn_rate', 'ltv'],
})

console.log('MRR:', analytics.mrr)
console.log('Annual Churn:', analytics.churn_rate)

// Cohort analysis
const cohorts = await stripe.analytics.cohorts({
  start: '2024-01-01',
  end: '2024-12-31',
  granularity: 'month',
})
```

### Metered Billing

```typescript
// Report usage for metered subscriptions
async function reportUsage(subscriptionItemId: string, quantity: number) {
  await stripe.subscriptionItems.createUsageRecord(subscriptionItemId, {
    quantity,
    timestamp: Math.floor(Date.now() / 1000),
    action: 'increment',
  })
}

// Usage reporting with batching
const usageReporter = stripe.createUsageReporter({
  batchSize: 100,
  flushInterval: 60000, // 1 minute
})

usageReporter.report('si_xxx', 10)
usageReporter.report('si_xxx', 5)
// Batched and sent efficiently
```

### Dunning Automation

```typescript
// Configure dunning behavior
await stripe.dunning.configure({
  retrySchedule: [1, 3, 7, 14], // Days after failure
  actions: {
    firstAttempt: 'email_reminder',
    secondAttempt: 'email_warning',
    thirdAttempt: 'email_final_notice',
    allFailed: 'cancel_subscription',
  },
  gracePeriod: 7, // Days before cancellation
})

// Manual retry
await stripe.dunning.retry('in_xxx')
```

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Client Applications                           │
├─────────────────┬─────────────────┬─────────────────┬───────────────────┤
│   HTTP/RPC      │   WebSocket     │   Webhooks      │  Service Binding  │
│   JSON-RPC      │   Real-time     │   Inbound       │  Worker-to-Worker │
├─────────────────┴─────────────────┴─────────────────┴───────────────────┤
│                         stripe.do Worker (Edge)                         │
├─────────────────────────────────────────────────────────────────────────┤
│  Smart Router    │  Orchestration   │  MCP Server   │  Analytics Engine │
├─────────────────────────────────────────────────────────────────────────┤
│                    Durable Objects (SQLite Audit Log)                   │
├──────────────────────────┬──────────────────────────────────────────────┤
│      Stripe API          │           Fallback Providers                 │
│   (Primary Provider)     │      (PayPal, Adyen, Square, etc.)           │
└──────────────────────────┴──────────────────────────────────────────────┘
```

stripe.do acts as an intelligent proxy to Stripe:

1. **Smart Routing** — Routes requests to optimal provider based on availability and latency
2. **Durable Audit Log** — Every transaction logged to Durable Object SQLite
3. **Edge Execution** — Processing happens at the edge, close to your users
4. **Orchestration** — Complex payment flows managed with durable workflows

## Payment Orchestration

### Retry Policies

```typescript
// Configure retry behavior
const stripe = new StripeClient({
  url: 'https://your-worker.workers.dev',
  retry: {
    maxAttempts: 3,
    backoff: 'exponential',
    initialDelay: 1000,
    maxDelay: 30000,
  },
})
```

### Multi-Provider Routing

```typescript
// Configure fallback providers
await stripe.routing.configure({
  primary: 'stripe',
  fallback: ['adyen', 'paypal'],
  rules: [
    { region: 'EU', prefer: 'adyen' },
    { paymentMethod: 'paypal', route: 'paypal' },
  ],
})
```

### Idempotency

All requests are automatically idempotent at the edge:

```typescript
// Same request, guaranteed single execution
const payment = await stripe.paymentIntents.create({
  amount: 2000,
  currency: 'usd',
}, {
  idempotencyKey: 'order_123_payment',
})

// Safe to retry - returns cached result
const payment2 = await stripe.paymentIntents.create({
  amount: 2000,
  currency: 'usd',
}, {
  idempotencyKey: 'order_123_payment',
})

console.log(payment.id === payment2.id) // true
```

## Configuration

### Basic Setup

```jsonc
{
  "vars": {
    "STRIPE_SECRET_KEY": "sk_live_xxx",
    "STRIPE_WEBHOOK_SECRET": "whsec_xxx",
    "STRIPE_API_VERSION": "2024-12-18.acacia"
  }
}
```

### With Analytics

```jsonc
{
  "analytics_engine_datasets": [
    { "binding": "ANALYTICS", "dataset": "stripe_events" }
  ],
  "vars": {
    "ANALYTICS_ENABLED": "true"
  }
}
```

### With Multi-Provider

```jsonc
{
  "vars": {
    "STRIPE_SECRET_KEY": "sk_live_xxx",
    "ADYEN_API_KEY": "xxx",
    "PAYPAL_CLIENT_ID": "xxx",
    "PAYPAL_CLIENT_SECRET": "xxx",
    "ROUTING_ENABLED": "true"
  }
}
```

## Audit Log & Time Travel

stripe.do maintains a complete audit log of all payment operations:

```typescript
// Query payment history
const history = await stripe.audit.query({
  customerId: 'cus_xxx',
  startDate: '2024-01-01',
  endDate: '2024-12-31',
})

// Time-travel query
const customerAsOf = await stripe.customers.retrieveAsOf(
  'cus_xxx',
  new Date('2024-06-15')
)

// Audit specific operation
const audit = await stripe.audit.get('pi_xxx')
console.log(audit.timeline) // Full timeline of status changes
```

## Development

```bash
# Install dependencies
npm install

# Run tests
npm test

# Local development
npm run dev

# Deploy
npm run deploy
```

## Related

- [@dotdo/stripe](/docs/integrations/stripe/package) - Drop-in Stripe SDK for testing
- [Durable Objects](/docs/architecture/durable-objects) - DO-backed storage
- [Workflows](/docs/workflows) - Durable workflow orchestration
- [Events Overview](/docs/events) - Event handling patterns
