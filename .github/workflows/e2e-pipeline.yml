name: E2E Pipeline Tests

on:
  # Scheduled runs every 4 hours
  schedule:
    - cron: '0 */4 * * *'
  # Manual trigger
  workflow_dispatch:
    inputs:
      include_iceberg:
        description: 'Include Iceberg sink tests (slower)'
        required: false
        default: true
        type: boolean
      test_timeout:
        description: 'Test timeout in minutes'
        required: false
        default: '30'
        type: string

concurrency:
  group: e2e-pipeline
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ============================================================================
  # E2E Pipeline Event Flow Tests
  # ============================================================================
  event-flow:
    name: Event Flow Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run event flow tests
        run: |
          pnpm vitest run testing/e2e/pipeline/event-flow.test.ts --reporter=verbose --timeout=120000
        env:
          NODE_ENV: test
          CLOUDFLARE_E2E: true
          E2E_ENVIRONMENT: staging
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          STAGING_URL: ${{ vars.STAGING_URL }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: event-flow-results
          path: test-results/
          retention-days: 14

  # ============================================================================
  # E2E Pipeline Sink Verification Tests
  # ============================================================================
  sink-verification:
    name: Sink Verification Tests
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.test_timeout || '30' }}
    if: github.event.inputs.include_iceberg != 'false'
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run sink verification tests
        run: |
          pnpm vitest run testing/e2e/pipeline/sink-verification.test.ts --reporter=verbose --timeout=300000
        env:
          NODE_ENV: test
          CLOUDFLARE_E2E: true
          E2E_ENVIRONMENT: staging
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          STAGING_URL: ${{ vars.STAGING_URL }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sink-verification-results
          path: test-results/
          retention-days: 14

  # ============================================================================
  # Full Pipeline Flow Tests
  # ============================================================================
  full-flow:
    name: Full Flow Tests
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.test_timeout || '30' }}
    needs: [event-flow]
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run full flow tests
        run: |
          pnpm vitest run testing/acid/phase5/full-flow.test.ts --reporter=verbose --timeout=300000
        env:
          NODE_ENV: test
          CLOUDFLARE_E2E: true
          E2E_ENVIRONMENT: staging
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          STAGING_URL: ${{ vars.STAGING_URL }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-flow-results
          path: test-results/
          retention-days: 14

  # ============================================================================
  # Latency Measurement Tests
  # ============================================================================
  latency:
    name: Latency Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [event-flow]
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run latency tests
        run: |
          pnpm vitest run testing/acid/phase5/latency.test.ts --reporter=verbose --timeout=120000
        env:
          NODE_ENV: test
          CLOUDFLARE_E2E: true
          E2E_ENVIRONMENT: staging
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          STAGING_URL: ${{ vars.STAGING_URL }}

      - name: Upload latency results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: latency-results
          path: test-results/
          retention-days: 14

  # ============================================================================
  # Summary and Reporting
  # ============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [event-flow, sink-verification, full-flow, latency]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
          merge-multiple: true
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## E2E Pipeline Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Event Flow | ${{ needs.event-flow.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sink Verification | ${{ needs.sink-verification.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Full Flow | ${{ needs.full-flow.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latency | ${{ needs.latency.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        if: |
          needs.event-flow.result == 'failure' ||
          needs.full-flow.result == 'failure'
        run: |
          echo "E2E Pipeline tests failed - check individual job results"
          exit 1

  # ============================================================================
  # Alert on SLA Violations
  # ============================================================================
  sla-check:
    name: SLA Compliance Check
    runs-on: ubuntu-latest
    needs: [latency]
    if: always() && needs.latency.result == 'success'

    steps:
      - name: Download latency results
        uses: actions/download-artifact@v4
        with:
          name: latency-results
          path: latency-results
        continue-on-error: true

      - name: Check SLA compliance
        run: |
          echo "Checking SLA compliance..."
          # Parse latency results and check against SLA targets
          # This is a placeholder - actual implementation would parse test output
          echo "SLA check complete"

      - name: Report SLA status
        run: |
          echo "## SLA Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| P50 Latency | 5s | TBD |" >> $GITHUB_STEP_SUMMARY
          echo "| P95 Latency | 30s | TBD |" >> $GITHUB_STEP_SUMMARY
          echo "| P99 Latency | 60s | TBD |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Latency | 5min | TBD |" >> $GITHUB_STEP_SUMMARY
