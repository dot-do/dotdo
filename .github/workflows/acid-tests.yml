name: ACID Test Suite

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run E2E tests every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - workers
          - e2e

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ============================================================================
  # Unit/Integration Tests (Fast - runs on every push)
  # ============================================================================
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.test_type != 'e2e' && github.event.inputs.test_type != 'workers'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ACID unit tests
        run: pnpm vitest run --project=acid --reporter=dot
        env:
          NODE_ENV: test

      - name: Run Phase 1-4 tests
        run: |
          pnpm vitest run tests/acid/phase1/ --reporter=dot || true
          pnpm vitest run tests/acid/phase2/ --reporter=dot || true
          pnpm vitest run tests/acid/phase3/ --reporter=dot || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  # ============================================================================
  # Workers Pool Tests (Medium - runs on every push)
  # ============================================================================
  workers-tests:
    name: Workers Runtime Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.test_type != 'unit' && github.event.inputs.test_type != 'e2e'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Workers pool tests
        run: |
          pnpm vitest run --project=workers --reporter=dot
          pnpm vitest run --project=workers-integration --reporter=dot || true
          pnpm vitest run --project=do-integration --reporter=dot || true
        env:
          NODE_ENV: test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workers-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  # ============================================================================
  # E2E Pipeline Tests (Slow - runs on schedule and main pushes)
  # ============================================================================
  e2e-pipeline:
    name: E2E Pipeline Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'schedule' ||
      github.event.inputs.test_type == 'e2e' ||
      github.event.inputs.test_type == 'all'
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run E2E Pipeline tests
        run: |
          pnpm vitest run testing/acid/phase5/ --reporter=verbose --timeout=120000
          pnpm vitest run testing/e2e/pipeline/ --reporter=verbose --timeout=120000
        env:
          NODE_ENV: test
          CLOUDFLARE_E2E: true
          E2E_ENVIRONMENT: staging
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          STAGING_URL: ${{ vars.STAGING_URL }}

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            coverage/
            test-results/
          retention-days: 14

  # ============================================================================
  # Smoke Tests (Fast - runs after deployment)
  # ============================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [unit-tests, workers-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run smoke tests
        run: pnpm vitest run testing/e2e/smoke/ --reporter=verbose --timeout=60000
        env:
          NODE_ENV: test
          CLOUDFLARE_E2E: true
          E2E_ENVIRONMENT: production
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          PRODUCTION_URL: ${{ vars.PRODUCTION_URL }}

      - name: Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: test-results/
          retention-days: 7

  # ============================================================================
  # Test Matrix (Optional - for comprehensive coverage)
  # ============================================================================
  test-matrix:
    name: Phase ${{ matrix.phase }} Tests (${{ matrix.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        phase: [1, 2, 3, 4]
        environment: [local, staging]
        exclude:
          # Phase 5+ requires real infrastructure
          - phase: 5
            environment: local

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Phase ${{ matrix.phase }} tests
        run: |
          pnpm vitest run tests/acid/phase${{ matrix.phase }}/ --reporter=dot || true
        env:
          NODE_ENV: test
          E2E_ENVIRONMENT: ${{ matrix.environment }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

  # ============================================================================
  # Summary Job
  # ============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, workers-tests]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
          merge-multiple: true
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## ACID Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workers Tests | ${{ needs.workers-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Run: ${{ github.run_number }} - ${{ github.sha }}_" >> $GITHUB_STEP_SUMMARY
