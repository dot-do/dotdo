---
title: Authentication
description: JWT storage claims and authentication utilities for tenant isolation
---

# Authentication (lib/auth/)

The auth module provides JWT-based authentication utilities for extracting and validating storage claims, enabling secure multi-tenant data isolation.

## Overview

Authentication in dotdo is built around JWT claims that determine what resources a user or service can access. The primary use case is extracting storage claims from JWTs to construct tenant-isolated R2 paths.

## JWT Storage Claims

The `extractStorageClaims` function validates JWTs and extracts claims used for storage path construction.

### Basic Usage

```typescript
import { extractStorageClaims } from 'lib/auth/jwt-storage-claims'

const jwt = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
const secret = new TextEncoder().encode('your-jwt-secret')

const claims = await extractStorageClaims(jwt, secret)
// => {
//   orgId: 'acme',
//   subject: 'user-123',
//   tenantId: 'tenant-456',
//   bucket: 'production-data',
//   pathPrefix: 'v1'
// }
```

### Claim Structure

```typescript
interface StorageClaims {
  /** Organization ID (required) - extracted from `org_id` claim */
  orgId: string

  /** Subject identifier - extracted from `sub` claim */
  subject: string

  /** Tenant ID (optional) - extracted from `tenant_id` claim */
  tenantId?: string

  /** R2 bucket name (optional) - from nested `storage.bucket` claim */
  bucket?: string

  /** Path prefix (optional) - from nested `storage.path_prefix` claim */
  pathPrefix?: string
}
```

### JWT Payload Format

The function expects JWTs with the following payload structure:

```json
{
  "sub": "user-123",
  "org_id": "acme",
  "tenant_id": "tenant-456",
  "storage": {
    "bucket": "production-data",
    "path_prefix": "v1"
  },
  "exp": 1704067200
}
```

### Error Handling

```typescript
import { extractStorageClaims } from 'lib/auth/jwt-storage-claims'

try {
  const claims = await extractStorageClaims(jwt, secret)
} catch (error) {
  if (error.message === 'Invalid JWT') {
    // JWT format is invalid or signature verification failed
  } else if (error.message === 'JWT expired') {
    // Token has expired
  } else if (error.message === 'Missing org_id') {
    // Required org_id claim is missing
  }
}
```

## Integration with AuthorizedR2Client

Storage claims are designed to work directly with the `AuthorizedR2Client`:

```typescript
import { extractStorageClaims } from 'lib/auth/jwt-storage-claims'
import { AuthorizedR2Client } from 'lib/storage/authorized-r2'

// Extract claims from request JWT
const authHeader = request.headers.get('Authorization')
const jwt = authHeader?.replace('Bearer ', '')
const storageClaims = await extractStorageClaims(jwt, secret)

// Create authorized client with claims
const client = new AuthorizedR2Client({
  orgId: storageClaims.orgId,
  tenantId: storageClaims.tenantId || 'default',
  bucket: storageClaims.bucket || 'default-bucket',
  pathPrefix: storageClaims.pathPrefix || ''
}, env.R2_BUCKET)

// All operations are now tenant-isolated
await client.put(doId, 'state.json', data)
```

## Middleware Pattern

Common pattern for protecting routes with JWT validation:

```typescript
import { extractStorageClaims, type StorageClaims } from 'lib/auth/jwt-storage-claims'

async function withAuth(
  request: Request,
  handler: (claims: StorageClaims) => Promise<Response>
): Promise<Response> {
  const authHeader = request.headers.get('Authorization')

  if (!authHeader?.startsWith('Bearer ')) {
    return new Response('Unauthorized', { status: 401 })
  }

  try {
    const jwt = authHeader.slice(7)
    const claims = await extractStorageClaims(jwt, JWT_SECRET)
    return await handler(claims)
  } catch (error) {
    if (error.message === 'JWT expired') {
      return new Response('Token expired', { status: 401 })
    }
    return new Response('Invalid token', { status: 401 })
  }
}
```

## Security Considerations

1. **Secret Management**: Store JWT secrets securely using Cloudflare secrets or environment variables
2. **Token Expiry**: Always check token expiration - the library validates `exp` claims automatically
3. **Claim Validation**: The `org_id` claim is required; operations will fail without it
4. **Path Isolation**: Claims are used to construct isolated storage paths, preventing cross-tenant access

## Type Exports

```typescript
import type { StorageClaims } from 'lib/auth/jwt-storage-claims'
```

## Related

- [Storage](/docs/lib/storage) - R2 storage with tenant isolation
- [Security](/docs/security) - Overall security architecture
- [DOAuth](/docs/objects/doauth) - Durable Object authentication
