---
title: DO Capabilities
description: Capabilities for Durable Objects - filesystem, git, bash, and npm
---

# DO Capabilities

Capabilities extend Durable Objects with additional features. Apply them to add `$.fs`, `$.git`, `$.bash`, and `$.npm` to your workflow context.

## Overview

```typescript
import { DO } from 'objects/DO'
import { withFs, withGit, withBash, withNpm } from 'lib/capabilities'

// Compose capabilities
class MyDO extends withGit(withFs(DO)) {
  async deploy() {
    await this.$.fs.write('/config.json', JSON.stringify(config))
    await this.$.git.add('.')
    await this.$.git.commit('chore: update config')
    await this.$.git.push()
  }
}
```

## withFs - Filesystem Capability

Adds `$.fs` for virtual filesystem operations backed by DO storage.

### Basic Operations

```typescript
class FileDO extends withFs(DO) {
  async setup() {
    // Write files
    await this.$.fs.write('/config.json', '{"version": 1}')

    // Read files
    const content = await this.$.fs.read('/config.json')

    // Check existence
    if (await this.$.fs.exists('/config.json')) {
      console.log('Config exists')
    }

    // Delete files
    await this.$.fs.delete('/config.json')
  }
}
```

### Directory Operations

```typescript
class DirDO extends withFs(DO) {
  async organize() {
    // Create directory
    await this.$.fs.mkdir('/data')
    await this.$.fs.mkdir('/data/nested/deep', { recursive: true })

    // List directory
    const entries = await this.$.fs.list('/data')
    // [{ name: 'file.txt', isDirectory: false }, ...]

    // Get stats
    const stats = await this.$.fs.stat('/data/file.txt')
    // { size, mtime, isDirectory, ... }
  }
}
```

### Copy and Move

```typescript
class CopyDO extends withFs(DO) {
  async backup() {
    // Copy file
    await this.$.fs.copy('/config.json', '/backups/config.json')

    // Move file
    await this.$.fs.move('/temp.txt', '/archive/temp.txt')
  }
}
```

### Storage Layout

The virtual filesystem uses DO storage with these key prefixes:

| Prefix | Content |
|--------|---------|
| `fsx:file:/path` | File content (string) |
| `fsx:meta:/path` | File metadata (JSON) |
| `fsx:dir:/path` | Directory marker (boolean) |

### Error Handling

```typescript
import { FsError } from 'lib/mixins/fs'

try {
  await this.$.fs.read('/missing.txt')
} catch (error) {
  if (error instanceof FsError) {
    switch (error.code) {
      case 'ENOENT':
        console.log('File not found:', error.path)
        break
      case 'EISDIR':
        console.log('Cannot read directory as file')
        break
      case 'ENOTDIR':
        console.log('Not a directory')
        break
    }
  }
}
```

Error codes follow POSIX conventions:
- `ENOENT` - No such file or directory
- `EEXIST` - File already exists
- `EISDIR` - Is a directory
- `ENOTDIR` - Not a directory
- `ENOTEMPTY` - Directory not empty
- `EACCES` - Permission denied

## withGit - Git Capability

Adds `$.git` for Git operations. Requires `withFs`.

### Basic Git Operations

```typescript
class GitDO extends withGit(withFs(DO)) {
  async version() {
    // Initialize repository
    await this.$.git.init()

    // Stage changes
    await this.$.git.add('.')

    // Commit
    await this.$.git.commit('Initial commit')

    // Check status
    const status = await this.$.git.status()
    // { staged: [...], modified: [...], untracked: [...] }
  }
}
```

### Remote Operations

```typescript
class RemoteGitDO extends withGit(withFs(DO)) {
  async sync() {
    // Clone repository
    await this.$.git.clone('https://github.com/org/repo.git')

    // Pull changes
    await this.$.git.pull()

    // Push changes
    await this.$.git.push()

    // Fetch
    await this.$.git.fetch()
  }
}
```

### Branching

```typescript
class BranchDO extends withGit(withFs(DO)) {
  async feature() {
    // Create branch
    await this.$.git.branch('feature/new-feature')

    // Switch branch
    await this.$.git.checkout('feature/new-feature')

    // Create and switch
    await this.$.git.checkout('feature/another', { create: true })

    // List branches
    const branches = await this.$.git.branches()
    // ['main', 'feature/new-feature', 'feature/another']

    // Merge
    await this.$.git.checkout('main')
    await this.$.git.merge('feature/new-feature')
  }
}
```

### History

```typescript
class HistoryDO extends withGit(withFs(DO)) {
  async audit() {
    // Get log
    const commits = await this.$.git.log({ limit: 10 })
    // [{ hash, message, author, date }, ...]

    // Get diff
    const diff = await this.$.git.diff('HEAD~1', 'HEAD')

    // Show commit
    const commit = await this.$.git.show('abc123')
  }
}
```

## withBash - Shell Capability

Adds `$.bash` for shell command execution. Requires `withFs`.

### Execute Commands

```typescript
class BashDO extends withBash(withFs(DO)) {
  async build() {
    // Execute command
    const result = await this.$.bash.exec('npm run build')
    // { stdout, stderr, exitCode }

    // With working directory
    await this.$.bash.exec('npm test', { cwd: '/project' })

    // With environment variables
    await this.$.bash.exec('node script.js', {
      env: { NODE_ENV: 'production' }
    })
  }
}
```

### Script Execution

```typescript
class ScriptDO extends withBash(withFs(DO)) {
  async deploy() {
    // Write and execute script
    await this.$.fs.write('/scripts/deploy.sh', `
      #!/bin/bash
      npm run build
      npm run deploy
    `)

    await this.$.bash.exec('bash /scripts/deploy.sh')
  }
}
```

### Piping and Chaining

```typescript
class PipeDO extends withBash(withFs(DO)) {
  async process() {
    // Pipe commands
    const result = await this.$.bash.exec(
      'cat data.json | jq ".items[]" | head -10'
    )

    // Chain commands
    await this.$.bash.exec('npm install && npm run build && npm test')
  }
}
```

### Options

```typescript
interface BashExecOptions {
  cwd?: string              // Working directory
  env?: Record<string, string>  // Environment variables
  timeout?: number          // Timeout in ms
  shell?: string           // Shell to use (default: /bin/sh)
}
```

## withNpm - Package Management

Adds `$.npm` for npm operations. Requires `withFs`.

### Package Installation

```typescript
class NpmDO extends withNpm(withFs(DO)) {
  async setup() {
    // Install all dependencies
    await this.$.npm.install()

    // Install specific package
    await this.$.npm.install('lodash')

    // Install dev dependency
    await this.$.npm.install('vitest', { dev: true })

    // Install global
    await this.$.npm.install('typescript', { global: true })
  }
}
```

### Package Scripts

```typescript
class ScriptsDO extends withNpm(withFs(DO)) {
  async build() {
    // Run npm scripts
    await this.$.npm.run('build')
    await this.$.npm.run('test')
    await this.$.npm.run('lint')

    // With arguments
    await this.$.npm.run('test', ['--coverage', '--watch'])
  }
}
```

### Package Management

```typescript
class PackageDO extends withNpm(withFs(DO)) {
  async manage() {
    // Uninstall package
    await this.$.npm.uninstall('old-package')

    // Update packages
    await this.$.npm.update()

    // List installed
    const packages = await this.$.npm.list()

    // Check outdated
    const outdated = await this.$.npm.outdated()
  }
}
```

## Composing Mixins

Mixins compose in order:

```typescript
// Full-featured DO with all capabilities
class FullDO extends withNpm(withBash(withGit(withFs(DO)))) {
  async fullWorkflow() {
    // Initialize project
    await this.$.git.init()

    // Create package.json
    await this.$.fs.write('/package.json', JSON.stringify({
      name: 'my-project',
      version: '1.0.0'
    }))

    // Install dependencies
    await this.$.npm.install()

    // Build
    await this.$.bash.exec('npm run build')

    // Commit and push
    await this.$.git.add('.')
    await this.$.git.commit('Initial setup')
    await this.$.git.push()
  }
}
```

### Dependency Requirements

| Mixin | Requires |
|-------|----------|
| `withFs` | None |
| `withGit` | `withFs` |
| `withBash` | `withFs` |
| `withNpm` | `withFs` |

```typescript
// Correct - fs comes before git
class Correct extends withGit(withFs(DO)) {}

// Error - git needs fs
class Wrong extends withFs(withGit(DO)) {}  // Won't work!
```

## Custom Mixins

Create custom capability mixins:

```typescript
import type { DO } from 'objects/DO'

// Define capability interface
interface DatabaseCapability {
  query<T>(sql: string): Promise<T[]>
  execute(sql: string): Promise<void>
}

// Create mixin
function withDatabase<T extends typeof DO>(Base: T) {
  return class extends Base {
    get database(): DatabaseCapability {
      // Return capability implementation
      return {
        query: async (sql) => { /* ... */ },
        execute: async (sql) => { /* ... */ }
      }
    }
  }
}

// Use custom mixin
class DataDO extends withDatabase(DO) {
  async fetch() {
    const users = await this.database.query('SELECT * FROM users')
  }
}
```

## Type Safety

Mixins preserve type safety:

```typescript
class MyDO extends withGit(withFs(DO)) {
  async work() {
    // Type-safe fs operations
    const content: string = await this.$.fs.read('/file.txt')

    // Type-safe git operations
    const status: GitStatus = await this.$.git.status()

    // Error: $.npm not available (mixin not applied)
    await this.$.npm.install()  // TypeScript error!
  }
}
```

## Related

- [Capabilities](/docs/lib/capabilities) - Capability system
- [Primitives](/docs/primitives) - fsx, gitx, bashx
- [Durable Objects](/docs/storage/durable-objects) - DO patterns
