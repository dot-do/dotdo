---
title: "@dotdo/stripe"
description: Drop-in replacement for the Stripe SDK with edge compatibility and local testing support.
---

# @dotdo/stripe

Drop-in replacement for the Stripe JavaScript SDK. Your existing `stripe` code works unchanged - just swap the import.

```typescript
// Before: Stripe
import Stripe from 'stripe'

// After: dotdo
import { Stripe } from '@dotdo/stripe'

// Code stays the same
const stripe = new Stripe(env.STRIPE_SECRET_KEY)

const customer = await stripe.customers.create({
  email: 'customer@example.com',
  name: 'John Doe',
})

const subscription = await stripe.subscriptions.create({
  customer: customer.id,
  items: [{ price: 'price_xxx' }],
})
```

<Callout type="info">
Looking for a managed edge service? See [stripe.do](/docs/integrations/stripe/service) for production payment orchestration on the edge.
</Callout>

## Why @dotdo/stripe?

| Stripe SDK | @dotdo/stripe |
|------------|---------------|
| Node.js runtime required | Edge-compatible (Cloudflare Workers) |
| Real API calls in tests | Local testing with StripeLocal |
| Network latency | Zero latency in local mode |
| Requires webhook tunnel for dev | Built-in webhook simulation |
| Separate test mode | Same code, different backends |

**This is a proxy/compatibility layer.** It can either forward to real Stripe APIs (production) or run entirely locally for testing and development. The API surface matches Stripe's official SDK.

## Installation

```bash
npm install @dotdo/stripe
```

## Features

### Production Client (Stripe)

The main `Stripe` client connects to Stripe's API and supports these resources:

**Customers**
- `create()`, `retrieve()`, `update()`, `del()`, `list()`, `search()`

**Subscriptions**
- `create()`, `retrieve()`, `update()`, `cancel()`, `list()`, `resume()`, `search()`

**Payment Intents**
- `create()`, `retrieve()`, `update()`, `confirm()`, `capture()`, `cancel()`, `list()`, `search()`
- `incrementAuthorization()` for extended auth

**Charges** (legacy)
- `create()`, `retrieve()`, `update()`, `capture()`, `list()`, `search()`

**Refunds**
- `create()`, `retrieve()`, `update()`, `cancel()`, `list()`

**Payment Methods**
- `create()`, `retrieve()`, `update()`, `attach()`, `detach()`, `list()`

**Webhooks**
- `constructEvent()` - Verify and parse webhook events
- `verifySignature()` - Signature validation only
- `generateTestHeaderString()` - Create test signatures

### Local Client (StripeLocal)

The `StripeLocal` client runs entirely in-memory for testing and includes additional resources:

**All Production APIs** plus:

**Products & Prices**
- Full CRUD for products and prices
- Lookup keys, recurring prices
- `retrieveByLookupKey()` for price lookup

**Webhook Endpoints**
- `create()`, `retrieve()`, `update()`, `del()`, `list()`
- Event delivery simulation

**Events**
- `retrieve()`, `list()` - Access to generated webhook events

**Time-Travel Queries** (StripeLocal extension)
- `customers.retrieveAsOf()` - Retrieve customer state at a point in time

### Not Yet Implemented

**Production Client:**
- Products & Prices (use StripeLocal for now, or contribute!)
- Invoices
- Checkout Sessions
- Connect (Accounts, Transfers, Payouts)
- Balance, Balance Transactions
- Setup Intents (types only)

**Both Clients:**
- Disputes
- Files, File Links
- Coupons, Promotion Codes
- Tax Rates
- Radar Rules
- Terminal
- Identity Verification
- Issuing
- Treasury

## Quick Start

### Basic Usage

```typescript
import { Stripe } from '@dotdo/stripe'

const stripe = new Stripe(env.STRIPE_SECRET_KEY)

// Create a customer
const customer = await stripe.customers.create({
  email: 'customer@example.com',
  name: 'John Doe',
  metadata: { plan: 'pro' },
})

// Create a payment intent
const paymentIntent = await stripe.paymentIntents.create({
  amount: 2000, // $20.00
  currency: 'usd',
  customer: customer.id,
  automatic_payment_methods: { enabled: true },
})

console.log('Client secret:', paymentIntent.client_secret)
```

## Local Testing with StripeLocal

For testing and development, use `StripeLocal` - a complete in-memory Stripe implementation:

```typescript
import { StripeLocal } from '@dotdo/stripe/local'

// Create local Stripe instance (no API key needed)
const stripe = new StripeLocal()

// Use exactly like real Stripe SDK
const customer = await stripe.customers.create({
  email: 'test@example.com',
})

const paymentIntent = await stripe.paymentIntents.create({
  amount: 2000,
  currency: 'usd',
  customer: customer.id,
})

// Confirm with idempotency
const confirmed = await stripe.paymentIntents.confirm(
  paymentIntent.id,
  {},
  { idempotencyKey: 'unique-key-123' }
)

console.log(confirmed.status) // 'succeeded'
```

### Webhook Events in Local Mode

```typescript
const stripe = new StripeLocal({
  webhooks: true,
  onWebhookEvent: async (event) => {
    console.log('Webhook event:', event.type)
    // Handle event...
  },
})

// Create operations trigger webhook events
const customer = await stripe.customers.create({
  email: 'test@example.com',
})
// onWebhookEvent receives: { type: 'customer.created', data: { object: customer } }
```

### Time-Travel Queries (StripeLocal Extension)

```typescript
const stripe = new StripeLocal()

const customer = await stripe.customers.create({ email: 'v1@example.com' })
const createdAt = Date.now()

await stripe.customers.update(customer.id, { email: 'v2@example.com' })

// Retrieve customer as it was at creation time
const historicalCustomer = await stripe.customers.retrieveAsOf(
  customer.id,
  createdAt
)
console.log(historicalCustomer.email) // 'v1@example.com'
```

### Test Billing Cycles

```typescript
const stripe = new StripeLocal()

const subscription = await stripe.subscriptions.create({
  customer: 'cus_xxx',
  items: [{ price: 'price_monthly' }],
})

// Advance time to trigger billing
stripe.subscriptions.advanceBilling(Date.now() + 30 * 24 * 60 * 60 * 1000)
```

## Edge Compatibility

Works in Cloudflare Workers without Node.js dependencies:

```typescript
// worker.ts
import { Stripe } from '@dotdo/stripe'

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const stripe = new Stripe(env.STRIPE_SECRET_KEY)

    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      success_url: 'https://example.com/success',
      cancel_url: 'https://example.com/cancel',
      line_items: [{ price: 'price_xxx', quantity: 1 }],
    })

    return Response.redirect(session.url!)
  },
}
```

### Custom Configuration

```typescript
const stripe = new Stripe('sk_test_xxx', {
  apiVersion: '2024-12-18.acacia', // API version
  maxNetworkRetries: 3,            // Retry count
  timeout: 60000,                  // Request timeout (ms)
  fetch: customFetch,              // Custom fetch implementation
  host: 'api.stripe.com',          // API host override
  protocol: 'https',               // Protocol override
})
```

## Webhooks

### Verifying Webhook Signatures

```typescript
import { Stripe } from '@dotdo/stripe'

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const payload = await request.text()
    const signature = request.headers.get('stripe-signature')!

    try {
      const event = await Stripe.webhooks.constructEvent(
        payload,
        signature,
        env.STRIPE_WEBHOOK_SECRET
      )

      switch (event.type) {
        case 'payment_intent.succeeded':
          const paymentIntent = event.data.object
          console.log('Payment succeeded:', paymentIntent.id)
          break

        case 'customer.subscription.created':
          const subscription = event.data.object
          console.log('New subscription:', subscription.id)
          break

        case 'invoice.paid':
          const invoice = event.data.object
          console.log('Invoice paid:', invoice.id)
          break
      }

      return new Response('OK', { status: 200 })
    } catch (err) {
      console.error('Webhook signature verification failed:', err)
      return new Response('Invalid signature', { status: 400 })
    }
  },
}
```

### Webhook Event Types

```typescript
import type { WebhookEvent, WebhookEventType } from '@dotdo/stripe'

// Common event types
type HandledEvents =
  | 'customer.created'
  | 'customer.updated'
  | 'customer.deleted'
  | 'customer.subscription.created'
  | 'customer.subscription.updated'
  | 'customer.subscription.deleted'
  | 'payment_intent.created'
  | 'payment_intent.succeeded'
  | 'payment_intent.payment_failed'
  | 'charge.succeeded'
  | 'charge.failed'
  | 'charge.refunded'
  | 'invoice.created'
  | 'invoice.paid'
  | 'invoice.payment_failed'
  | 'checkout.session.completed'
```

### Test Webhook Signatures

```typescript
import { Stripe } from '@dotdo/stripe'

const payload = JSON.stringify({
  id: 'evt_test',
  type: 'payment_intent.succeeded',
  // ...
})

const signature = await Stripe.webhooks.generateTestHeaderString({
  payload,
  secret: 'whsec_test',
  timestamp: Math.floor(Date.now() / 1000),
})

// Use in tests
const event = await Stripe.webhooks.constructEvent(
  payload,
  signature,
  'whsec_test'
)
```

## Subscriptions

### Create a Subscription

```typescript
const subscription = await stripe.subscriptions.create({
  customer: 'cus_xxx',
  items: [{ price: 'price_monthly' }],
  payment_behavior: 'default_incomplete',
  payment_settings: { save_default_payment_method: 'on_subscription' },
  expand: ['latest_invoice.payment_intent'],
})
```

### Update Subscription Items

```typescript
const subscription = await stripe.subscriptions.update('sub_xxx', {
  items: [
    { id: 'si_xxx', deleted: true },
    { price: 'price_annual' },
  ],
  proration_behavior: 'create_prorations',
})
```

### Cancel at Period End

```typescript
const subscription = await stripe.subscriptions.update('sub_xxx', {
  cancel_at_period_end: true,
})
```

### Cancel Immediately

```typescript
const subscription = await stripe.subscriptions.cancel('sub_xxx', {
  invoice_now: true,
  prorate: true,
})
```

## Request Options

All methods accept optional request options:

```typescript
const customer = await stripe.customers.create(
  { email: 'test@example.com' },
  {
    idempotencyKey: 'unique-request-key',  // Idempotent requests
    stripeAccount: 'acct_xxx',              // Connect account
    apiVersion: '2024-01-01',               // Version override
    maxNetworkRetries: 5,                   // Retry count
    timeout: 30000,                         // Timeout (ms)
  }
)
```

## Error Handling

```typescript
import { Stripe, StripeAPIError } from '@dotdo/stripe'

try {
  await stripe.customers.retrieve('cus_nonexistent')
} catch (error) {
  if (error instanceof StripeAPIError) {
    console.log('Type:', error.type)           // 'invalid_request_error'
    console.log('Code:', error.code)           // 'resource_missing'
    console.log('Message:', error.message)     // 'No such customer...'
    console.log('Status:', error.statusCode)   // 404
    console.log('Param:', error.param)         // 'id'
    console.log('Request ID:', error.requestId)
  }
}
```

### Error Types

| Type | Description |
|------|-------------|
| `api_error` | Stripe API error |
| `card_error` | Card declined or invalid |
| `idempotency_error` | Idempotency key conflict |
| `invalid_request_error` | Invalid parameters |
| `authentication_error` | Invalid API key |
| `rate_limit_error` | Too many requests |

## Types

Full TypeScript support with comprehensive type definitions:

```typescript
import type {
  // Core types
  Customer,
  Subscription,
  PaymentIntent,
  Charge,
  Refund,
  PaymentMethod,
  Price,
  SetupIntent,

  // Params (all implemented resources)
  CustomerCreateParams,
  CustomerUpdateParams,
  CustomerListParams,
  SubscriptionCreateParams,
  SubscriptionUpdateParams,
  SubscriptionListParams,
  SubscriptionCancelParams,
  PaymentIntentCreateParams,
  PaymentIntentUpdateParams,
  PaymentIntentConfirmParams,
  PaymentIntentCaptureParams,
  PaymentIntentCancelParams,
  PaymentIntentListParams,
  ChargeCreateParams,
  ChargeUpdateParams,
  ChargeCaptureParams,
  ChargeListParams,
  RefundCreateParams,
  RefundUpdateParams,
  RefundListParams,

  // Responses
  ListResponse,
  DeletedObject,
  DeletedCustomer,

  // Webhooks
  WebhookEvent,
  WebhookEventType,

  // Errors
  StripeError,
  StripeErrorResponse,
  PaymentError,

  // Utilities
  Metadata,
  Address,
  Shipping,
  BillingDetails,
  RequestOptions,
  RangeQueryParam,
} from '@dotdo/stripe'

// For StripeLocal, additional types are available:
import type {
  Product,
  ProductCreateParams,
  ProductUpdateParams,
  ProductListParams,
  PriceCreateParams,
  PriceUpdateParams,
  PriceListParams,
} from '@dotdo/stripe/local'
```

## Testing with StripeLocal

StripeLocal is ideal for unit tests - no external Stripe API required:

```typescript
import { StripeLocal } from '@dotdo/stripe/local'

describe('PaymentService', () => {
  let stripe: StripeLocal

  beforeEach(() => {
    // Fresh in-memory Stripe for each test
    stripe = new StripeLocal()
  })

  it('should create a subscription', async () => {
    const customer = await stripe.customers.create({
      email: 'test@example.com',
    })

    const product = await stripe.products.create({
      name: 'Pro Plan',
    })

    const price = await stripe.prices.create({
      product: product.id,
      unit_amount: 2000,
      currency: 'usd',
      recurring: { interval: 'month' },
    })

    const subscription = await stripe.subscriptions.create({
      customer: customer.id,
      items: [{ price: price.id }],
    })

    expect(subscription.status).toBe('active')
  })
})
```

## Migration from Stripe SDK

### Package Change

```bash
# Remove
npm uninstall stripe

# Install
npm install @dotdo/stripe
```

### Import Change

```typescript
// Before
import Stripe from 'stripe'
const stripe = new Stripe('sk_test_xxx')

// After (named import)
import { Stripe } from '@dotdo/stripe'
const stripe = new Stripe('sk_test_xxx')

// Or default import
import Stripe from '@dotdo/stripe'
const stripe = new Stripe('sk_test_xxx')
```

### Code Compatibility

Your existing Stripe code should work unchanged:

```typescript
// This code works with both stripe and @dotdo/stripe
const customer = await stripe.customers.create({
  email: 'customer@example.com',
})

const subscription = await stripe.subscriptions.create({
  customer: customer.id,
  items: [{ price: 'price_xxx' }],
})

const paymentIntent = await stripe.paymentIntents.create({
  amount: 2000,
  currency: 'usd',
  customer: customer.id,
})
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Your Application                          │
│                                                              │
│  const stripe = new Stripe(key) // or StripeLocal()         │
│  await stripe.customers.create(...)                          │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│   Production Mode        │     │     Local Mode          │
│   (Stripe)               │     │     (StripeLocal)       │
├─────────────────────────┤     ├─────────────────────────┤
│                         │     │                         │
│  → api.stripe.com       │     │  → In-memory storage    │
│  → Real payments        │     │  → No network calls     │
│  → Live/test keys       │     │  → Webhook simulation   │
│  → Full Stripe API      │     │  → Time-travel queries  │
│                         │     │                         │
└─────────────────────────┘     └─────────────────────────┘
```

### Local Mode Benefits

- **Zero latency**: No network round-trips
- **No API limits**: Unlimited requests
- **Predictable**: No external dependencies
- **Testable**: Control time, simulate failures
- **Offline**: Works without internet

## API Coverage

| Resource | Stripe (Production) | StripeLocal | Notes |
|----------|---------------------|-------------|-------|
| Customers | Full | Full | All CRUD + search + time-travel |
| Subscriptions | Full | Full | Including pause/resume |
| Payment Intents | Full | Full | Including incremental auth |
| Charges | Full | Full | Legacy API |
| Refunds | Full | Full | Including cancel |
| Payment Methods | Full | - | Attach/detach |
| Products | Not yet | Full | CRUD (local only) |
| Prices | Not yet | Full | One-time and recurring (local only) |
| Invoices | Not yet | Not yet | Planned |
| Checkout Sessions | Not yet | Not yet | Planned |
| Accounts (Connect) | Not yet | Not yet | Planned |
| Transfers | Not yet | Not yet | Planned |
| Payouts | Not yet | Not yet | Planned |
| Webhooks | Full | Full | Signature verification |
| Webhook Endpoints | - | Full | Endpoint management (local only) |
| Events | - | Full | Event retrieval (local only) |
| Setup Intents | Types only | Types only | |
| Coupons | Not yet | Not yet | |
| Tax Rates | Not yet | Not yet | |
| Disputes | Not yet | Not yet | |

## Related

- [stripe.do](/docs/integrations/stripe/service) - Managed Stripe on the edge
- [Events Overview](/docs/events) - Event handling including webhooks
- [SDK Events](/docs/sdk/events) - Event subscription patterns
- [Compat SDKs](/docs/compat) - All API-compatible SDKs
