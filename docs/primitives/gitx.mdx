---
title: gitx - Git on R2
description: Git protocol implementation using R2 for blob storage and Durable Objects for refs
---

# gitx - Git on R2

Your agents need version control. They can't shell out to `git`. We built Git from scratch.

gitx implements the Git object model on Cloudflare R2. Blobs, trees, and commits are content-addressable objects in R2. Refs live in Durable Object metadata. SHA-1 hashing uses `crypto.subtle`.

## Quick Start

```typescript
// Configure git binding (done in DO initialization)
$.git.configure({
  repo: 'org/repo',
  branch: 'main',
  r2: env.R2_BUCKET
})

// Sync from R2 object store
await $.git.sync()

// Make changes
await $.fs.write('src/feature.ts', newCode)

// Stage and commit
await $.git.add('src/feature.ts')
await $.git.commit('feat: add new feature')

// Push to R2
await $.git.push()
```

## Configuration

Configure the git binding for your Durable Object:

```typescript
// In your DO initialization
$.git.configure({
  repo: 'org/repo',
  branch: 'main',
  r2: env.R2_BUCKET,
  path: 'packages/core'  // Optional: subdirectory
})

// Check binding
const binding = $.git.binding
console.log(`Tracking ${binding.repo}@${binding.branch}`)
console.log(`Current commit: ${binding.commit}`)
```

## Core Operations

### Status

```typescript
const status = await $.git.status()

console.log(`Branch: ${status.branch}`)
console.log(`HEAD: ${status.head}`)
console.log(`Clean: ${status.clean}`)

// Staged files ready to commit
for (const file of status.staged) {
  console.log(`Staged: ${file}`)
}

// Modified but not staged
for (const file of status.unstaged) {
  console.log(`Modified: ${file}`)
}
```

### Staging Files

```typescript
// Stage single file
await $.git.add('src/index.ts')

// Stage multiple files
await $.git.add(['src/a.ts', 'src/b.ts', 'tests/a.test.ts'])

// Stage all changes
await $.git.add('.')

// Stage by pattern
await $.git.add('src/**/*.ts')
```

### Committing

```typescript
// Simple commit
const result = await $.git.commit('feat: implement feature')
console.log(`Created commit: ${result.hash}`)

// Commit with options
await $.git.commit('fix: resolve bug', {
  author: 'Agent Ralph <ralph@agents.do>',
  allowEmpty: false
})
```

### Sync and Push

```typescript
// Pull latest changes from R2
const syncResult = await $.git.sync()
console.log(`Fetched ${syncResult.objectsFetched} objects`)
console.log(`Wrote ${syncResult.filesWritten} files`)
console.log(`Now at: ${syncResult.commit}`)

// Push local changes to R2
const pushResult = await $.git.push()
console.log(`Pushed ${pushResult.objectsPushed} objects`)
```

## How It Works

### Git Object Model

Git stores everything as content-addressable objects:

```
┌──────────────────────────────────────────────────────────┐
│                    R2 Object Store                       │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  git/objects/ab/cdef1234...  (blob - file content)       │
│  git/objects/12/345678ab...  (tree - directory listing)  │
│  git/objects/fe/dcba9876...  (commit - snapshot + meta)  │
│                                                          │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                  DO Metadata (Refs)                      │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  refs/heads/main -> fedcba9876...                        │
│  refs/heads/feature-branch -> 1234567890...              │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### SHA-1 via crypto.subtle

Every object is hashed to compute its address:

```typescript
// How gitx computes SHA-1
async function hashObject(type: string, data: Uint8Array): Promise<string> {
  const header = new TextEncoder().encode(`${type} ${data.length}\0`)
  const full = new Uint8Array([...header, ...data])

  const hash = await crypto.subtle.digest('SHA-1', full)
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('')
}
```

### R2 Object Layout

Objects are stored with a two-character prefix for efficient listing:

```
git/objects/
  ab/
    cdef1234567890abcdef1234567890abcdef12  (blob)
  12/
    34567890abcdef1234567890abcdef12345678  (tree)
  fe/
    dcba9876543210fedcba9876543210fedcba98  (commit)
```

## Diff and Log

```typescript
// View diff of working changes (placeholder implementation)
const diff = await $.git.diff()
console.log(diff)

// Commit history (returns current commit only)
const commits = await $.git.log({ limit: 10 })
for (const commit of commits) {
  console.log(`${commit.hash.slice(0, 7)} ${commit.message}`)
}
```

Note: `diff()` and `log()` have placeholder implementations. Full diff output and commit traversal are not yet available.

## Working with Remotes

gitx uses R2 as its "remote", but can sync with GitHub:

```typescript
// Configure GitHub remote
$.git.configure({
  repo: 'org/repo',
  branch: 'main',
  r2: env.R2_BUCKET,
  github: {
    token: env.GITHUB_TOKEN,
    syncOnPush: true  // Auto-sync to GitHub
  }
})

// Push syncs to both R2 and GitHub
await $.git.push()
```

## Multi-Agent Collaboration

Multiple agents can work on the same repository via R2:

```typescript
// Agent 1: Make changes and push
await agent1.$.fs.write('src/a.ts', codeA)
await agent1.$.git.add('src/a.ts')
await agent1.$.git.commit('feat: add A')
await agent1.$.git.push()

// Agent 2: Sync to see Agent 1's changes, then add more
await agent2.$.git.sync()
await agent2.$.fs.write('src/b.ts', codeB)
await agent2.$.git.add('src/b.ts')
await agent2.$.git.commit('feat: add B')
await agent2.$.git.push()
```

R2's consistency model ensures all agents see the same objects once written.

Note: Branch operations (`checkout`, `branch`, `merge`, `rebase`) are not yet implemented. Multi-agent workflows currently operate on a single branch.

## Error Handling

Git operations throw standard `Error` objects with descriptive messages:

```typescript
try {
  await $.git.push()
} catch (error) {
  // Check error message for specific conditions
  const message = (error as Error).message

  if (message.includes('not configured')) {
    console.log('R2 bucket not configured')
  } else if (message.includes('No commits to push')) {
    console.log('Nothing to push - commit first')
  } else if (message.includes('Nothing to commit')) {
    console.log('No staged changes')
  } else {
    throw error
  }
}
```

## Type Definitions

```typescript
interface GitBinding {
  repo: string
  branch: string
  path?: string
  commit?: string
  lastSync?: Date
}

interface GitStatus {
  branch: string
  head?: string
  staged: string[]
  unstaged: string[]
  untracked?: string[]
  clean: boolean
}

interface GitCommitResult {
  hash: string
}

interface SyncResult {
  success: boolean
  objectsFetched: number
  filesWritten: number
  commit?: string
  error?: string
}

interface PushResult {
  success: boolean
  objectsPushed: number
  commit?: string
  error?: string
}
```

## Performance

| Operation | Time | Notes |
|-----------|------|-------|
| status | < 5ms | Local DO state |
| add (single file) | < 2ms | Local staging |
| commit | 10-50ms | Create objects, hash |
| sync (100 objects) | 200-500ms | R2 parallel fetch |
| push (10 objects) | 100-300ms | R2 parallel put |

## Comparison to Git CLI

| Feature | @dotdo/gitx | Git CLI |
|---------|-------------|---------|
| Object storage | R2 bucket | Local `.git/` |
| Ref storage | DO metadata | Local files |
| Network protocol | R2 API | SSH/HTTPS |
| Hashing | crypto.subtle | libgit2 |
| Edge deployment | Yes | No |
| Multi-agent | Native R2 consistency | Needs coordination |

## Technical Details

For implementation details, architecture decisions, and contributor documentation:

- **[gitx README](https://github.com/dotdo/dotdo/blob/main/primitives/gitx/README.md)** - Package documentation with 5,600+ tests, full Git protocol implementation (pack files, delta compression, smart HTTP), tiered storage architecture, MCP tools, and CLI reference

### Key Implementation Details

| Feature | Implementation |
|---------|----------------|
| SHA-1 hashing | `crypto.subtle` (Web Crypto API) |
| Object storage | R2 with two-character prefix layout |
| Refs storage | Durable Object metadata |
| Pack engine | OFS_DELTA and REF_DELTA compression, MIDX support |
| Wire protocol | Smart HTTP with capability negotiation |

## Next Steps

- [fsx](/docs/primitives/fsx) - The filesystem that gitx tracks
- [bashx](/docs/primitives/bashx) - Run git hooks and build scripts
- [Capabilities](/docs/sdk/capabilities) - Add git to your DOs
