---
title: Workers
description: Deployment patterns for routing, sharding, and replication in Cloudflare Workers
---

# Workers

The Workers module provides deployment patterns for routing requests to Durable Objects, distributing load across shards, and scaling reads with replicas.

## Overview

Workers sit between incoming requests and Durable Objects, handling:

- **Routing** - Extract namespace, type, and ID from URLs (subdomain, path, path-base patterns)
- **Sharding** - Distribute data across multiple DOs using consistent hashing with virtual nodes
- **Replication** - Route reads to replicas for horizontal scaling with round-robin load balancing
- **RPC Proxy** - Handle authentication, authorization, and JSON-RPC 2.0 protocol for Cap'n Web RPC

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Cloudflare Edge                            │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                            Worker                                   │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │
│  │  Routing  │→ │ Sharding  │→ │Replication│→ │ RPC Proxy │        │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘        │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    ▼              ▼              ▼
              ┌──────────┐  ┌──────────┐  ┌──────────┐
              │    DO    │  │    DO    │  │    DO    │
              │ (Shard 1)│  │ (Shard 2)│  │ (Primary)│
              └──────────┘  └──────────┘  └──────────┘
                                               │
                                    ┌──────────┼──────────┐
                                    ▼          ▼          ▼
                              ┌──────────┐ ┌──────────┐ ┌──────────┐
                              │ Replica  │ │ Replica  │ │ Replica  │
                              │    1     │ │    2     │ │    N     │
                              └──────────┘ └──────────┘ └──────────┘
```

## Routing Patterns

dotdo supports three URL routing patterns for multi-tenancy:

| Pattern | URL Example | Namespace Extraction |
|---------|-------------|---------------------|
| **Subdomain** | `tenant.api.dotdo.dev/customers/123` | From subdomain |
| **Path** | `api.dotdo.dev/tenant/customers/123` | First path segment |
| **Path-Base** | `api.dotdo.dev/v1/tenant/customers/123` | After version prefix |

[Learn more about Routing](/workers/routing)

## Scaling Strategies

### Horizontal Sharding

Distribute data across multiple DOs using consistent hashing:

```typescript
import { createShardedWorker } from 'dotdo/workers'

const worker = createShardedWorker({
  rootDomain: 'api.dotdo.dev',
  shardCount: 16,
})
```

[Learn more about Sharding](/workers/sharding)

### Read Replicas

Scale reads by routing to replica DOs:

```typescript
import { createReplicatedWorker } from 'dotdo/workers'

const worker = createReplicatedWorker({
  replicaCount: 3,
})
```

[Learn more about Replication](/workers/replication)

## Presets

Pre-configured deployment patterns for common use cases:

| Preset | Use Case | Description |
|--------|----------|-------------|
| `single` | Simple apps | One DO per namespace |
| `typed` | Type isolation | Separate DO per `namespace:type` combination |
| `sharded` | High volume | Consistent hash distribution across N shards |
| `replicated` | Read heavy | Primary + read replicas with round-robin |

[Learn more about Presets](/workers/presets)

## RPC Proxy

The RPC proxy handles Cap'n Web RPC requests with authentication and authorization:

```typescript
import { createRPCProxy } from 'dotdo/workers'

const proxy = createRPCProxy({
  authenticate: async (request) => {
    const token = request.headers.get('Authorization')
    if (!token?.startsWith('Bearer ')) {
      return { valid: false }
    }
    return { valid: true, identity: 'user-123' }
  },
  authorize: async (identity, method) => {
    // Block admin methods for non-admins
    return !method.startsWith('admin.')
  },
})
```

Features:
- JSON-RPC 2.0 protocol support (single and batch requests)
- Streaming method detection (SSE for `events.stream`, `events.subscribe`)
- Identity-based authorization

## Quick Start

### Basic Worker

The minimal worker passthrough:

```typescript
import { DO } from 'dotdo/objects'

export { DO }

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url)
    const hostParts = url.hostname.split('.')
    const ns = hostParts.length > 2 ? hostParts[0] : 'default'

    const id = env.DO.idFromName(ns)
    const stub = env.DO.get(id)

    return stub.fetch(request)
  }
}
```

### Production Worker

Combine routing, sharding, and replication:

```typescript
import { createProductionWorker } from 'dotdo/workers'

const worker = createProductionWorker({
  rootDomain: 'api.dotdo.dev',
  shardCount: 16,
  replicaCount: 3,
  authenticate: async (req) => {
    const token = req.headers.get('Authorization')
    return !!token?.startsWith('Bearer ')
  },
})

export default {
  fetch: worker.handleRequest,
}
```

## Type Definitions

```typescript
/** Parsed URL route info extracted from request */
interface RouteInfo {
  ns: string           // Namespace (tenant)
  type?: string        // Resource type (e.g., 'customers')
  id?: string          // Resource ID (e.g., '123')
  remainingPath: string // Path after extraction
}

/** Worker routing configuration */
interface RoutingConfig {
  mode: 'subdomain' | 'path' | 'path-base'
  rootDomain?: string  // e.g., 'api.dotdo.dev'
  basePath?: string    // e.g., '/v1' for versioned APIs
}

/** Shard configuration for consistent hashing */
interface ShardConfig {
  shardCount: number
  virtualNodes?: number  // Default 150 for even distribution
  replicationFactor?: number
}

/** Replication configuration */
interface ReplicationConfig {
  mode: 'primary-replica' | 'multi-primary'
  replicaCount: number
  readPreference: 'primary' | 'replica' | 'nearest'
}

/** Request intent for replication routing */
type RequestIntent = 'read' | 'write' | 'unknown'

/** RPC proxy configuration */
interface RPCProxyConfig {
  authenticate: (request: Request) => Promise<{ valid: boolean; identity?: string }>
  authorize?: (identity: string, method: string) => Promise<boolean>
}

/** Consistent hash ring interface */
interface ConsistentHashRing {
  addNode(node: string): void
  removeNode(node: string): void
  getNode(key: string): string
  getNodes(): string[]
  getVirtualNodeCount(): number
}
```

## Module Exports

All worker utilities are exported from `dotdo/workers`:

```typescript
// Types
export type {
  RouteInfo,
  RoutingConfig,
  ShardConfig,
  ReplicationConfig,
  RequestIntent,
  ConsistentHashRing,
  RPCProxyConfig,
  RPCProxy,
  ReplicaRouter,
  WorkerPreset,
  WorkerPresetInstance,
}

// Routing
export { parseSubdomainRoute, parsePathRoute, parsePathBaseRoute }

// Sharding
export { createHashRing, hashKey }

// Replication
export { detectIntent, createReplicaRouter }

// RPC Proxy
export { createRPCProxy }

// Presets
export { createWorkerPreset, createShardedWorker, createReplicatedWorker, createProductionWorker }
```

## Next Steps

- [Routing](/workers/routing) - URL routing patterns
- [Sharding](/workers/sharding) - Horizontal scaling with consistent hashing
- [Replication](/workers/replication) - Read replica routing
- [Presets](/workers/presets) - Ready-to-use configurations
- [RPC Proxy](/workers/rpc-proxy) - Authentication and JSON-RPC 2.0 support
