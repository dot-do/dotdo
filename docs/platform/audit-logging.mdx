---
title: Audit Logging
description: Comprehensive audit trail for compliance, security monitoring, and operational insights
---

import { Callout } from 'fumadocs-ui/components/callout'

# Audit Logging

Every action in dotdo creates an audit trail. Know who did what, when, and why.

## Overview

When AI agents and humans collaborate in autonomous businesses, accountability matters. dotdo automatically logs every action with full context - actor identity, timestamps, changes, and outcomes. No configuration required for basic logging; deep customization available when you need it.

<Callout type="info" title="Automatic Audit Logging">
All CRUD operations, authentication events, and system actions are automatically logged. You only need to add custom logging for business-specific events.
</Callout>

## Audit Log Structure

Every audit log entry includes comprehensive context:

```json
{
  "id": "audit_abc123xyz",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "actor": {
    "type": "human",
    "id": "user_abc123",
    "email": "alice@example.com",
    "ip": "192.168.1.1",
    "userAgent": "Mozilla/5.0...",
    "sessionId": "sess_xyz789"
  },
  "action": "Customer.update",
  "resource": {
    "type": "customer",
    "id": "cust_xyz789",
    "namespace": "acme"
  },
  "changes": {
    "before": { "email": "old@example.com" },
    "after": { "email": "new@example.com" }
  },
  "result": "success",
  "context": {
    "environment": "production",
    "region": "eu-west-1",
    "requestId": "req_123456",
    "traceId": "trace_abc"
  }
}
```

## Actor Types

dotdo tracks three types of actors:

### Human Actors

```json
{
  "actor": {
    "type": "human",
    "id": "user_abc123",
    "email": "alice@example.com",
    "name": "Alice Johnson",
    "roles": ["admin", "finance"],
    "ip": "192.168.1.1",
    "userAgent": "Mozilla/5.0...",
    "sessionId": "sess_xyz789",
    "mfaVerified": true
  }
}
```

### Agent Actors

```json
{
  "actor": {
    "type": "agent",
    "id": "tom-do",
    "email": "tom@agents.do",
    "name": "Tom",
    "role": "tech-lead",
    "capabilities": ["code.review", "pr.approve"],
    "invokedBy": "user_abc123",
    "model": "claude-sonnet-4-20250514"
  }
}
```

### Service Actors

```json
{
  "actor": {
    "type": "service",
    "id": "workflow_abc",
    "name": "order-processor",
    "triggeredBy": "schedule",
    "workflowId": "wf_xyz789"
  }
}
```

## Automatic Logging

### CRUD Operations

All database operations are automatically logged:

```typescript
// This create operation...
await $.db.customers.create({
  name: 'Acme Corp',
  email: 'contact@acme.com',
})

// ...automatically generates this audit log:
{
  "action": "Customer.create",
  "resource": { "type": "customer", "id": "cust_new123" },
  "changes": {
    "before": null,
    "after": { "name": "Acme Corp", "email": "contact@acme.com" }
  },
  "result": "success"
}
```

### Authentication Events

```typescript
// Login attempts (success and failure)
{
  "action": "auth.login",
  "result": "success",
  "context": {
    "method": "oauth",
    "provider": "google",
    "mfaRequired": true,
    "mfaMethod": "totp"
  }
}

// Session events
{
  "action": "auth.session.expired",
  "context": {
    "sessionDuration": "8h",
    "reason": "idle_timeout"
  }
}
```

### Authorization Events

```typescript
// Access granted
{
  "action": "auth.access.granted",
  "resource": { "type": "customer", "id": "cust_123" },
  "context": {
    "permission": "Customer.read",
    "role": "support"
  }
}

// Access denied
{
  "action": "auth.access.denied",
  "resource": { "type": "refund", "id": "ref_456" },
  "result": "denied",
  "context": {
    "permission": "Refund.approve",
    "requiredRole": "finance",
    "userRoles": ["support"]
  }
}
```

## Custom Audit Events

Log business-specific events:

```typescript
// Payment processing
await $.audit.log('payment.processed', {
  customerId: customer.id,
  amount: payment.amount,
  currency: payment.currency,
  paymentMethod: 'card',
  last4: '4242', // Safe to log
  // Never log: full card number, CVV
})

// Refund approval
await $.audit.log('refund.approved', {
  orderId: order.id,
  amount: refund.amount,
  approvedBy: $.user.id,
  reason: refund.reason,
  escalatedFrom: refund.originalHandler,
})

// Document access
await $.audit.log('document.accessed', {
  documentId: doc.id,
  documentType: 'contract',
  accessType: 'download',
  classification: doc.classification,
})
```

## Sensitive Data Handling

### Automatic Redaction

Sensitive fields are automatically redacted:

```typescript
// Input to audit log
await $.audit.log('user.updated', {
  userId: user.id,
  changes: {
    password: 'new-password-hash',
    ssn: '123-45-6789',
    apiKey: 'sk_live_abc123xyz',
  },
})

// Stored in audit log (redacted)
{
  "changes": {
    "password": "[REDACTED]",
    "ssn": "***-**-6789",
    "apiKey": "sk_live_***"
  }
}
```

### Configuring Redaction

```typescript
$.configure({
  audit: {
    redact: {
      fields: ['password', 'ssn', 'apiKey', 'cardNumber', 'cvv'],
      patterns: [
        { regex: /\b\d{3}-\d{2}-\d{4}\b/, mask: '***-**-$$$$' }, // SSN
        { regex: /\b\d{16}\b/, mask: '****-****-****-$$$$' }, // Card
      ],
    },
  },
})
```

### Excluding Fields

```typescript
// Exclude high-volume, low-value fields
$.configure({
  audit: {
    exclude: {
      fields: ['lastSeen', 'viewCount', 'cacheHit'],
      actions: ['healthCheck', 'metrics.collect'],
    },
  },
})
```

## Audit Log Retention

### Retention Policies

```typescript
$.configure({
  audit: {
    retention: {
      default: '7y',          // 7 years for most logs
      financial: '10y',       // 10 years for financial
      security: '5y',         // 5 years for security events
      operational: '90d',     // 90 days for operational logs
    },
    immutable: true,          // Cannot be deleted
    encryption: 'AES-256-GCM',
  },
})
```

### Tiered Storage

```typescript
$.configure({
  audit: {
    storage: {
      hot: {
        duration: '30d',
        storage: 'sqlite',     // Fast local queries
      },
      warm: {
        duration: '1y',
        storage: 'r2',         // Object storage
      },
      cold: {
        duration: '10y',
        storage: 'glacier',    // Archive storage
      },
    },
  },
})
```

## Querying Audit Logs

### Basic Search

```typescript
const logs = await $.audit.search({
  actor: 'user_abc123',
  action: 'Customer.*',
  startDate: '2024-01-01',
  endDate: '2024-01-31',
  limit: 100,
})
```

### Advanced Queries

```typescript
// Find all failed operations
const failures = await $.audit.search({
  result: 'failure',
  startDate: '2024-01-01',
  limit: 50,
})

// Find all actions by agents
const agentActions = await $.audit.search({
  'actor.type': 'agent',
  action: ['Customer.*', 'Order.*'],
  startDate: '2024-01-01',
})

// Find high-value refunds
const highValueRefunds = await $.audit.search({
  action: 'refund.approved',
  'data.amount': { $gte: 1000 },
  startDate: '2024-01-01',
})
```

### Resource History

```typescript
// Get complete history for a resource
const history = await $.audit.history({
  resource: {
    type: 'customer',
    id: 'cust_xyz789',
  },
  includeRelated: true, // Include related resources
})

// Timeline view
for (const event of history) {
  console.log(`${event.timestamp}: ${event.actor.email} ${event.action}`)
  if (event.changes) {
    console.log(`  Changed: ${Object.keys(event.changes.after).join(', ')}`)
  }
}
```

## Export and Reporting

### Export Formats

```typescript
// CSV export for spreadsheet analysis
const csv = await $.audit.export({
  format: 'csv',
  filters: {
    action: ['Customer.delete', 'Refund.approve'],
    period: 'last-90-days',
  },
})

// JSON export for programmatic processing
const json = await $.audit.export({
  format: 'json',
  filters: {
    'actor.type': 'agent',
    period: 'last-30-days',
  },
})

// PDF report for compliance
const report = await $.audit.export({
  format: 'pdf',
  template: 'compliance-report',
  period: 'Q1-2024',
})
```

### Scheduled Reports

```typescript
// Daily security report
$.every.day.at6am(async ($) => {
  const report = await $.audit.generateReport({
    type: 'security-summary',
    period: 'last-24-hours',
    include: [
      'failed-logins',
      'access-denied',
      'unusual-activity',
    ],
  })

  await $.email.send({
    to: 'security@company.com',
    subject: 'Daily Security Audit Report',
    attachments: [report],
  })
})

// Weekly compliance report
$.every.Monday.at9am(async ($) => {
  const report = await $.audit.generateReport({
    type: 'compliance',
    frameworks: ['gdpr', 'soc2'],
    period: 'last-7-days',
  })

  await $.email.send({
    to: 'compliance@company.com',
    subject: 'Weekly Compliance Report',
    attachments: [report],
  })
})
```

## Tamper-Proof Logging

### Cryptographic Verification

Audit logs are cryptographically secured to prevent tampering:

```json
{
  "entry": { ... },
  "hash": "sha256:abc123...",
  "previousHash": "sha256:xyz789...",
  "signature": "ed25519:...",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### Integrity Verification

```typescript
// Verify log integrity for a period
const result = await $.audit.verifyIntegrity({
  startDate: '2024-01-01',
  endDate: '2024-01-31',
})

if (!result.valid) {
  await $.alert.security('Audit log tampering detected', {
    affectedRange: result.affectedRange,
    firstInvalidEntry: result.firstInvalid,
  })
}

// Continuous integrity monitoring
$.every.hour(async ($) => {
  const valid = await $.audit.verifyIntegrity({
    period: 'last-hour',
  })

  if (!valid) {
    await $.alert.critical('Audit log integrity check failed')
  }
})
```

## Real-Time Monitoring

### Event Streaming

```typescript
// Stream audit events for real-time monitoring
$.on.Audit.event(async ($, event) => {
  // Forward to SIEM
  await $.siem.send(event)

  // Check for suspicious patterns
  if (event.action.includes('delete') && event.actor.type === 'agent') {
    await $.alert.security('Agent performed delete operation', event)
  }
})
```

### Anomaly Detection

```typescript
// Detect unusual patterns
$.on.Audit.event(async ($, event) => {
  const anomalies = await $.security.detectAnomalies(event, {
    patterns: [
      'geo-impossible-travel',
      'unusual-time',
      'bulk-operations',
      'privilege-escalation',
    ],
  })

  if (anomalies.length > 0) {
    await $.alert.security('Anomalous activity detected', {
      event,
      anomalies,
    })
  }
})
```

### Rate-Based Alerts

```typescript
// Alert on unusual operation rates
$.configure({
  audit: {
    alerts: {
      'failed-logins': {
        threshold: 5,
        window: '5m',
        action: 'block-ip',
      },
      'bulk-deletes': {
        threshold: 100,
        window: '1h',
        action: 'notify-admin',
      },
    },
  },
})
```

## Compliance Requirements

### GDPR Audit Requirements

```typescript
// Log all PII access
$.on.Data.piiAccess(async ($, { userId, field, accessor }) => {
  await $.audit.log('pii.accessed', {
    dataSubject: userId,
    field,
    accessor,
    lawfulBasis: await $.consent.getBasis(userId, field),
  })
})

// Log consent changes
$.on.Consent.changed(async ($, { userId, purpose, granted }) => {
  await $.audit.log('consent.changed', {
    dataSubject: userId,
    purpose,
    granted,
    source: $.request.headers.get('Referer'),
  })
})
```

### SOC 2 Audit Requirements

```typescript
// Log all privileged access
$.on.Admin.action(async ($, action) => {
  await $.audit.log('admin.action', {
    action: action.type,
    target: action.resource,
    justification: action.reason,
    approvedBy: action.approver,
  })
})

// Log all configuration changes
$.on.Config.changed(async ($, change) => {
  await $.audit.log('config.changed', {
    setting: change.key,
    before: change.oldValue,
    after: change.newValue,
    changedBy: $.user.id,
  })
})
```

### HIPAA Audit Requirements

```typescript
// Log all PHI access
$.configure({
  hipaa: {
    auditPHI: true,
    logAccess: 'all', // all, write-only, or modifications
    includeViewer: true,
  },
})

// Automatic PHI access logging
// When configured, all PHI access is logged:
{
  "action": "phi.accessed",
  "patient": "patient_123",
  "accessor": "user_456",
  "purpose": "treatment",
  "data": ["demographics", "diagnosis"],
  "minimumNecessary": true
}
```

## Integration with External Systems

### SIEM Integration

```typescript
$.configure({
  audit: {
    siem: {
      provider: 'splunk', // or 'datadog', 'elastic', 'sumo-logic'
      endpoint: process.env.SIEM_ENDPOINT,
      apiKey: await $.vault.get('siem_api_key'),
      realtime: true,
    },
  },
})
```

### Log Aggregation

```typescript
$.configure({
  audit: {
    forward: [
      {
        destination: 'cloudwatch',
        logGroup: '/dotdo/audit',
      },
      {
        destination: 'webhook',
        url: process.env.AUDIT_WEBHOOK_URL,
        batchSize: 100,
        flushInterval: '1m',
      },
    ],
  },
})
```

## Best Practices

### Log Meaningful Context

```typescript
// Good: Meaningful context
await $.audit.log('order.canceled', {
  orderId: order.id,
  reason: 'customer-request',
  refundIssued: true,
  refundAmount: order.total,
  customerNotified: true,
})

// Bad: Missing context
await $.audit.log('order.canceled', {
  orderId: order.id,
})
```

### Use Consistent Action Names

```typescript
// Good: Consistent naming
'Customer.create'
'Customer.update'
'Customer.delete'
'Order.create'
'Order.cancel'

// Bad: Inconsistent naming
'createCustomer'
'CUSTOMER_UPDATE'
'delete-customer'
```

### Include Before/After for Changes

```typescript
// Good: Track what changed
await $.audit.log('customer.updated', {
  customerId: customer.id,
  changes: {
    before: { status: 'active', tier: 'basic' },
    after: { status: 'active', tier: 'premium' },
  },
})
```

## Related Documentation

- [Compliance](/docs/platform/compliance) - GDPR, SOC 2, and regulatory requirements
- [Security Hardening](/docs/platform/security) - Production security configuration
- [Authorization](/docs/security/authorization) - Access control patterns
- [Vault](/docs/security/vault) - Secure secret storage
