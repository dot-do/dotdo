---
title: Preview Deployments
description: Deploy preview environments for branches and pull requests with isolated Durable Objects and automatic cleanup
---

# Preview Deployments

Preview deployments let you test changes in isolated environments before merging to production. Each branch or pull request gets its own deployment with separate Durable Objects, KV namespaces, and other bindings.

## Branch Deployments

### Configuration

Configure preview deployments in your `wrangler.jsonc`:

```json
{
  "name": "my-startup",
  "main": "src/index.ts",
  "compatibility_date": "2024-01-01",

  // Enable preview deployments
  "env": {
    "preview": {
      "name": "my-startup-preview",
      "workers_dev": true,

      // Use preview-specific bindings
      "kv_namespaces": [
        { "binding": "CACHE", "id": "preview-kv-id", "preview_id": "preview-kv-preview-id" }
      ],

      "durable_objects": {
        "bindings": [
          { "name": "STARTUP", "class_name": "Startup" }
        ]
      }
    }
  }
}
```

### Deploying a Branch

```bash
# Deploy current branch as preview
wrangler deploy --env preview

# The deployment URL will be:
# my-startup-preview.<your-subdomain>.workers.dev
```

### Branch-Specific Names

For unique URLs per branch:

```bash
#!/bin/bash
# deploy-preview.sh

BRANCH=$(git branch --show-current | tr '/' '-')
PREVIEW_NAME="my-startup-preview-${BRANCH}"

# Update wrangler.jsonc dynamically
cat > wrangler.preview.toml << EOF
name = "${PREVIEW_NAME}"
main = "src/index.ts"
compatibility_date = "2024-01-01"
workers_dev = true

[[durable_objects.bindings]]
name = "STARTUP"
class_name = "Startup"

[[migrations]]
tag = "v1"
new_classes = ["Startup"]
EOF

wrangler deploy --config wrangler.preview.toml
```

## Pull Request Previews

### GitHub Actions Integration

```yaml
name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm ci
      - run: npm run build

      - name: Deploy Preview
        id: deploy
        run: |
          PREVIEW_NAME="my-startup-pr-${{ github.event.pull_request.number }}"

          # Create preview-specific wrangler config
          cat > wrangler.preview.toml << EOF
          name = "${PREVIEW_NAME}"
          main = "dist/worker.js"
          compatibility_date = "2024-01-01"
          workers_dev = true

          [[durable_objects.bindings]]
          name = "STARTUP"
          class_name = "Startup"

          [[migrations]]
          tag = "v1"
          new_classes = ["Startup"]
          EOF

          # Deploy and capture URL
          OUTPUT=$(wrangler deploy --config wrangler.preview.toml 2>&1)
          URL=$(echo "$OUTPUT" | grep -o 'https://[^ ]*workers.dev')
          echo "url=$URL" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Preview Deployment

              Your preview is ready at: ${{ steps.deploy.outputs.url }}

              This preview will be automatically deleted when the PR is closed.`
            })
```

### Automatic Cleanup

Clean up preview deployments when PRs are closed:

```yaml
name: Cleanup Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Delete Preview
        run: |
          PREVIEW_NAME="my-startup-pr-${{ github.event.pull_request.number }}"
          wrangler delete --name "$PREVIEW_NAME" --force
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
```

## Isolated Data

### Preview-Specific Durable Objects

Each preview deployment gets isolated Durable Objects:

```typescript
import { Startup } from 'dotdo'

export class MyStartup extends Startup {
  async fetch(request: Request) {
    // Data is isolated per preview deployment
    // PR #123's data is separate from PR #124's data
    const customers = await this.things.Customer.list()
    return Response.json(customers)
  }
}
```

### Seeding Preview Data

Seed preview environments with test data:

```typescript
// src/seed.ts
export async function seedPreviewData(startup: Startup) {
  // Create test customers
  await startup.things.Customer.create({
    id: 'test-customer-1',
    name: 'Test Customer',
    email: 'test@example.com',
  })

  // Create test orders
  await startup.things.Order.create({
    id: 'test-order-1',
    customerId: 'test-customer-1',
    total: 99.99,
  })
}
```

```typescript
// src/index.ts
import { seedPreviewData } from './seed'

export class MyStartup extends Startup {
  async init() {
    // Seed data on first request to preview
    if (this.env.ENVIRONMENT === 'preview') {
      const seeded = await this.storage.get('seeded')
      if (!seeded) {
        await seedPreviewData(this)
        await this.storage.put('seeded', true)
      }
    }
  }
}
```

### Copying Production Data

For realistic previews, copy a subset of production data:

```typescript
// scripts/copy-prod-data.ts
import { createClient } from '@cloudflare/workers-sdk'

async function copyProdToPreview(previewName: string) {
  const prodClient = createClient({ env: 'production' })
  const previewClient = createClient({ env: previewName })

  // Copy sample customers (anonymized)
  const customers = await prodClient.things.Customer.list({ limit: 100 })

  for (const customer of customers) {
    await previewClient.things.Customer.create({
      ...customer,
      email: `preview-${customer.id}@example.com`,
      name: 'Preview User',
    })
  }
}
```

## Testing Previews

### Automated Testing

Run tests against preview deployments:

```yaml
name: Preview Tests

on:
  deployment_status:
    states: [success]

jobs:
  test:
    if: github.event.deployment_status.environment == 'preview'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run E2E Tests
        run: |
          PREVIEW_URL="${{ github.event.deployment_status.target_url }}"
          npm run test:e2e -- --base-url="$PREVIEW_URL"
```

### Visual Regression Testing

```yaml
- name: Visual Regression
  run: |
    npx playwright test --project=visual
  env:
    BASE_URL: ${{ steps.deploy.outputs.url }}

- name: Upload Screenshots
  if: failure()
  uses: actions/upload-artifact@v4
  with:
    name: visual-diff
    path: test-results/
```

### API Testing

```typescript
// tests/preview.test.ts
import { describe, it, expect } from 'vitest'

describe('Preview API', () => {
  const baseUrl = process.env.PREVIEW_URL

  it('should return healthy status', async () => {
    const res = await fetch(`${baseUrl}/health`)
    expect(res.status).toBe(200)
  })

  it('should create a customer', async () => {
    const res = await fetch(`${baseUrl}/customers`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: 'Test Customer',
        email: 'test@example.com',
      }),
    })
    expect(res.status).toBe(201)
  })

  it('should list customers', async () => {
    const res = await fetch(`${baseUrl}/customers`)
    const data = await res.json()
    expect(Array.isArray(data)).toBe(true)
  })
})
```

## Preview URLs

### Custom Preview Domains

Configure custom domains for previews:

```toml
[env.preview]
routes = [
  { pattern = "preview-*.example.com/*", zone_name = "example.com" }
]
```

### URL Patterns

| Deployment Type | URL Pattern |
|-----------------|-------------|
| Default Preview | `my-startup-preview.<subdomain>.workers.dev` |
| PR Preview | `my-startup-pr-123.<subdomain>.workers.dev` |
| Branch Preview | `my-startup-preview-feature-xyz.<subdomain>.workers.dev` |
| Custom Domain | `preview-123.example.com` |

## Best Practices

### Resource Limits

Set conservative limits for previews:

```toml
[env.preview]
# Use development bindings
[[env.preview.kv_namespaces]]
binding = "CACHE"
preview_id = "dev-kv-id"  # Separate from production

# Lower usage limits in code
[env.preview.vars]
MAX_REQUESTS_PER_MINUTE = "100"
MAX_STORAGE_MB = "50"
```

### Preview Expiration

Automatically expire old previews:

```bash
#!/bin/bash
# cleanup-old-previews.sh

# List all deployments
DEPLOYMENTS=$(wrangler deployments list --json)

# Find previews older than 7 days
OLD_PREVIEWS=$(echo "$DEPLOYMENTS" | jq -r '.[] | select(.name | startswith("my-startup-pr-")) | select(.created_at < (now - 7*24*60*60 | todate)) | .name')

for preview in $OLD_PREVIEWS; do
  echo "Deleting old preview: $preview"
  wrangler delete --name "$preview" --force
done
```

### Security Considerations

```typescript
// Protect preview deployments
export class MyStartup extends Startup {
  async fetch(request: Request) {
    if (this.env.ENVIRONMENT === 'preview') {
      // Require authentication for previews
      const auth = request.headers.get('Authorization')
      if (auth !== `Bearer ${this.env.PREVIEW_TOKEN}`) {
        return new Response('Unauthorized', { status: 401 })
      }
    }

    return this.handleRequest(request)
  }
}
```

## Related

- [Cloudflare Deployment](/docs/deployment/cloudflare) - Base deployment configuration
- [Rollbacks](/docs/deployment/rollback) - Version management
- [Monitoring](/docs/deployment/monitoring) - Health checks for previews
