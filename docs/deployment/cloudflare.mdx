---
title: Cloudflare Workers Deployment
description: Deploy dotdo applications to Cloudflare Workers with Wrangler configuration, secrets management, and multi-environment setup
---

# Cloudflare Workers Deployment

dotdo runs on Cloudflare Workers, leveraging V8 isolates and Durable Objects for persistent state. This guide covers everything you need to deploy your application to production.

## Prerequisites

Before deploying, ensure you have:

- A Cloudflare account with Workers Paid plan (required for Durable Objects)
- Wrangler CLI installed (`npm install -g wrangler`)
- Authentication configured (`wrangler login`)

```bash
# Verify your setup
wrangler whoami
```

## Wrangler Configuration

### Basic Configuration

Create a `wrangler.jsonc` in your project root:

```json
{
  "name": "my-startup",
  "main": "src/index.ts",
  "compatibility_date": "2024-01-01",

  // Account and zone configuration
  "account_id": "your-account-id",

  // Enable Node.js compatibility
  "node_compat": true,

  "build": {
    "command": "npm run build"
  },

  // Durable Object bindings
  "durable_objects": {
    "bindings": [
      { "name": "STARTUP", "class_name": "Startup" }
    ]
  },

  // Durable Object migrations
  "migrations": [
    { "tag": "v1", "new_classes": ["Startup"] }
  ]
}
```

### Full Configuration Example

```json
{
  "name": "my-startup",
  "main": "dist/worker.js",
  "compatibility_date": "2024-01-01",
  "compatibility_flags": ["nodejs_compat"],
  "account_id": "abc123...",

  "build": {
    "command": "npm run build",
    "watch_dir": "src"
  },

  // KV Namespace bindings
  "kv_namespaces": [
    { "binding": "CACHE", "id": "kv-namespace-id" }
  ],

  // R2 bucket bindings
  "r2_buckets": [
    { "binding": "STORAGE", "bucket_name": "my-bucket" }
  ],

  // D1 Database bindings
  "d1_databases": [
    { "binding": "DB", "database_name": "my-database", "database_id": "d1-database-id" }
  ],

  // Durable Objects
  "durable_objects": {
    "bindings": [
      { "name": "STARTUP", "class_name": "Startup" },
      { "name": "CUSTOMER", "class_name": "Customer" }
    ]
  },

  "migrations": [
    { "tag": "v1", "new_classes": ["Startup", "Customer"] }
  ],

  // Vectorize index bindings
  "vectorize": [
    { "binding": "EMBEDDINGS", "index_name": "embeddings" }
  ],

  // AI bindings
  "ai": {
    "binding": "AI"
  },

  // Analytics Engine
  "analytics_engine_datasets": [
    { "binding": "ANALYTICS", "dataset": "my-analytics" }
  ],

  // Queues
  "queues": {
    "producers": [
      { "queue": "my-queue", "binding": "QUEUE" }
    ],
    "consumers": [
      { "queue": "my-queue", "max_batch_size": 10, "max_batch_timeout": 30 }
    ]
  }
}
```

## Environment Variables

### Plain Text Variables

Set non-sensitive configuration in `wrangler.jsonc`:

```json
{
  "vars": {
    "ENVIRONMENT": "production",
    "LOG_LEVEL": "info",
    "API_VERSION": "v1"
  }
}
```

### Accessing Variables

```typescript
export default {
  async fetch(request: Request, env: Env) {
    console.log(`Running in ${env.ENVIRONMENT}`)
    console.log(`Log level: ${env.LOG_LEVEL}`)
    return new Response('OK')
  }
}
```

## Secrets Management

### Setting Secrets

Use `wrangler secret` for sensitive values:

```bash
# Interactive prompt (recommended)
wrangler secret put DATABASE_URL
wrangler secret put API_SECRET
wrangler secret put STRIPE_SECRET_KEY

# From environment variable
echo $DATABASE_URL | wrangler secret put DATABASE_URL

# From file
cat .secrets/api-key.txt | wrangler secret put API_KEY
```

### Listing Secrets

```bash
wrangler secret list
```

### Deleting Secrets

```bash
wrangler secret delete OLD_SECRET
```

### Bulk Secret Management

For managing multiple secrets, create a script:

```bash
#!/bin/bash
# deploy-secrets.sh

secrets=(
  "DATABASE_URL"
  "API_SECRET"
  "STRIPE_SECRET_KEY"
  "OPENAI_API_KEY"
)

for secret in "${secrets[@]}"; do
  if [ -n "${!secret}" ]; then
    echo "${!secret}" | wrangler secret put "$secret"
  else
    echo "Warning: $secret not set"
  fi
done
```

### Environment-Specific Secrets

```bash
# Production secrets
wrangler secret put DATABASE_URL --env production

# Staging secrets
wrangler secret put DATABASE_URL --env staging
```

## Multiple Environments

### Environment Configuration

Define environments in `wrangler.jsonc`:

```json
{
  "name": "my-startup",
  "main": "src/index.ts",
  "compatibility_date": "2024-01-01",

  // Shared configuration
  "vars": {
    "API_VERSION": "v1"
  },

  "env": {
    // Development environment
    "development": {
      "name": "my-startup-dev",
      "vars": { "ENVIRONMENT": "development", "LOG_LEVEL": "debug" },
      "kv_namespaces": [
        { "binding": "CACHE", "id": "dev-kv-id" }
      ],
      "durable_objects": {
        "bindings": [
          { "name": "STARTUP", "class_name": "Startup" }
        ]
      }
    },

    // Staging environment
    "staging": {
      "name": "my-startup-staging",
      "vars": { "ENVIRONMENT": "staging", "LOG_LEVEL": "info" },
      "routes": [{ "pattern": "staging.example.com/*", "zone_name": "example.com" }],
      "kv_namespaces": [
        { "binding": "CACHE", "id": "staging-kv-id" }
      ],
      "durable_objects": {
        "bindings": [
          { "name": "STARTUP", "class_name": "Startup" }
        ]
      }
    },

    // Production environment
    "production": {
      "name": "my-startup",
      "vars": { "ENVIRONMENT": "production", "LOG_LEVEL": "warn" },
      "routes": [{ "pattern": "api.example.com/*", "zone_name": "example.com" }],
      "kv_namespaces": [
        { "binding": "CACHE", "id": "prod-kv-id" }
      ],
      "durable_objects": {
        "bindings": [
          { "name": "STARTUP", "class_name": "Startup" }
        ]
      }
    }
  }
}
```

### Deploying to Environments

```bash
# Deploy to development
wrangler deploy --env development

# Deploy to staging
wrangler deploy --env staging

# Deploy to production
wrangler deploy --env production
```

### Custom Domains

Configure custom domains per environment:

```toml
[env.production]
routes = [
  { pattern = "api.example.com/*", zone_name = "example.com" },
  { pattern = "api.example.io/*", zone_name = "example.io" }
]

# Or use workers.dev subdomain
[env.staging]
workers_dev = true
```

## Deployment Commands

### Basic Deployment

```bash
# Deploy to production
npm run deploy
# or
wrangler deploy

# Deploy with verbose output
wrangler deploy --verbose

# Dry run (show what would be deployed)
wrangler deploy --dry-run
```

### Deployment Scripts

Add to your `package.json`:

```json
{
  "scripts": {
    "deploy": "wrangler deploy",
    "deploy:dev": "wrangler deploy --env development",
    "deploy:staging": "wrangler deploy --env staging",
    "deploy:prod": "wrangler deploy --env production"
  }
}
```

### CI/CD Integration

GitHub Actions example:

```yaml
name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm ci
      - run: npm run build
      - run: npm test

      - name: Deploy to Staging
        if: github.event_name == 'pull_request'
        run: wrangler deploy --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy to Production
        if: github.ref == 'refs/heads/main'
        run: wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
```

## Local Development

### Development Server

```bash
# Start local dev server
wrangler dev

# With specific environment
wrangler dev --env development

# On a specific port
wrangler dev --port 8787

# With remote resources (hit real KV, D1, etc.)
wrangler dev --remote
```

### Local Persistence

```bash
# Persist Durable Object state between restarts
wrangler dev --persist

# Specify persistence directory
wrangler dev --persist-to .wrangler/state
```

## Troubleshooting

### Common Issues

**Durable Object migrations failing:**

```bash
# Check migration status
wrangler deployments list

# Force new migration tag
[[migrations]]
tag = "v2"  # Increment this
new_classes = ["Startup"]
```

**Secrets not available:**

```bash
# Verify secrets are set for correct environment
wrangler secret list --env production
```

**Build failures:**

```bash
# Clear cache and rebuild
rm -rf dist node_modules/.cache
npm run build
wrangler deploy
```

### Viewing Logs

```bash
# Tail real-time logs
wrangler tail

# Filter by status
wrangler tail --status error

# Filter by search term
wrangler tail --search "customer"

# With specific environment
wrangler tail --env production
```

## Related

- [Preview Deployments](/docs/deployment/preview) - Branch and PR previews
- [Rollbacks](/docs/deployment/rollback) - Version management and rollbacks
- [Monitoring](/docs/deployment/monitoring) - Health checks and alerting
- [Observability](/docs/observability) - Logging, metrics, and tracing
