# CLI REPL Design

## Overview

A REPL-style CLI (like mongosh) for interacting with Durable Objects. Features OAuth authentication, DO listing from workers.do, folder linking, TypeScript autocomplete via LSP, and secure code execution via ai-evaluate.

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dotdo CLI (Bun + Ink)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ oauth.do/   â”‚  â”‚ workers.do   â”‚  â”‚ REPL Engine       â”‚  â”‚
â”‚  â”‚ node        â”‚  â”‚ (registry)   â”‚  â”‚ + TS LSP          â”‚  â”‚
â”‚  â”‚             â”‚  â”‚              â”‚  â”‚ + ai-evaluate     â”‚  â”‚
â”‚  â”‚ ensureLogin â”‚  â”‚ list/deploy  â”‚  â”‚ + $ (capnweb)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
   oauth.do             workers.do           Target DO
   (auth)               (registry +          (REPL target)
                        deployments +
                        custom domains)
```

## Key Decisions

### 1. Authentication

Use `oauth.do/node` package:

```typescript
import { ensureLoggedIn } from 'oauth.do/node'

const user = await ensureLoggedIn()
```

### 2. Registry: workers.do

workers.do is the platform layer handling:
- Worker/DO deployments
- Custom domain configuration (Cloudflare for SaaS)
- Listing user's workers sorted by activity (created/deployed/accessed)

API surface:
- `$.workers.list()` - list user's workers
- `$.workers.link(folder, doUrl)` - associate folder with DO
- `$.workers.deploy(...)` - deploy from folder
- `$.domains.add(...)` - custom hostname config

### 3. Configuration: do.config.ts

```typescript
import type { DO } from 'dotdo'

export default {
  $id: 'https://startups.studio',
} satisfies DO.Config
```

The `$id` is the DO's namespace URL - its globally unique identity.

### 4. Client Exports

```typescript
// Auto-configured from do.config.ts (access level based on auth)
import { $ } from 'dotdo'

// Explicit namespace when needed
import { $Context, $AdminContext } from 'dotdo'
const $user = $Context('https://example.com.ai')     // Force user-level
const $admin = $AdminContext('https://example.com.ai') // Force admin-level
```

- `$` / `$Context` - User types (public API defined on the DO)
- `$AdminContext` - Admin types (functions, workflows, actions, events, users, orgs, etc.)
- Auth determines access level automatically for `$`

### 5. Type Generation â†’ .do/types.d.ts

```bash
dotdo generate   # Pull types from connected DO
```

Flow:
1. DO exposes types via `GET /.do/types.d.ts` endpoint
2. `dotdo generate` fetches and writes to `.do/types.d.ts` in project
3. TypeScript picks up via tsconfig paths
4. IDE gets full autocomplete everywhere

Project structure:
```
project/
â”œâ”€â”€ .do/
â”‚   â””â”€â”€ types.d.ts      â† Generated from connected DO
â”œâ”€â”€ do.config.ts
â””â”€â”€ ...
```

Auto-generate triggers:
- `dotdo connect`
- `dotdo deploy` (after successful deploy)
- `dotdo generate` (manual)

Generated `.do/types.d.ts`:
```typescript
// Generated by dotdo - do not edit
// Source: https://startups.studio

declare module 'dotdo' {
  export namespace DO {
    export interface Config {
      $id: string
      env?: 'production' | 'staging' | 'development'
    }

    // DO-specific types
    export interface Customer {
      $id: string
      name: string
      email: string
    }

    export interface Things {
      Customer: Customer
      Order: Order
    }

    export interface Events { /* ... */ }
    export interface Actions { /* ... */ }
  }

  export const $: DOClient<DO.Things>
}
```

### 6. Global $id URLs

Every `$id` is a fully qualified, dereferenceable URL:

```typescript
const customer = await $.Customer('Alice')
console.log(customer.$id)  // 'https://startups.studio/Customer/Alice'

// DO's own $id
console.log($.$id)  // 'https://startups.studio'
```

Stored efficiently internally (`Customer/Alice`), API returns full URLs.

This enables **Thing â†” DO promotion/demotion**:
- `https://startups.studio/Customer/Alice` can be a Thing OR a sub-DO
- Promote when it outgrows being a Thing
- Demote when consolidating
- URL remains stable - clients don't care which it is

### 7. REPL Stack

- **Bun** runtime
- **Ink** for React-based TUI
- **TypeScript Language Service** for completions (in-process)
- **ai-evaluate** for secure code execution
- **capnweb** RPC to target DO

## CLI Commands

```bash
dotdo                    # Start REPL (ensureLoggedIn â†’ list DOs â†’ select â†’ connect)
dotdo connect            # Connect current folder to a DO (interactive picker)
dotdo connect <url>      # Connect folder to specific DO
dotdo list               # List all your DOs (from workers.do)
dotdo deploy             # Deploy current folder to connected DO
dotdo domains            # Manage custom domains for connected DO
dotdo generate           # Pull types from connected DO
```

## REPL UX

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ startups.studio                          nathan@... â”‚  â† Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ > await $.things.list({ $type: 'Cust              â”‚  â† Input + autocomplete
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ Customer            â”‚                          â”‚
â”‚   â”‚ CustomerEvent       â”‚                          â”‚
â”‚   â”‚ CustomerAction      â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [{ $id: 'https://startups.studio/Customer/cust_1', â”‚  â† Output
â”‚    name: 'Alice' }, ...]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Startup flow:**
```
$ dotdo

ğŸ” Logged in as nathan@example.com

Your Workers (most recent first):
  1. startups.studio      (accessed 2 min ago)
  2. platform.do          (deployed 1 hour ago)
  3. api.myapp.com        (created yesterday)

Select worker [1]: 1

Connected to startups.studio
Type TypeScript. Tab for autocomplete. .help for commands.

startups.studio>
```

**REPL commands:**
- `.help` - show commands
- `.clear` - clear output
- `.types` - regenerate types
- `.switch` - switch to different DO
- `Ctrl+C` - exit

## REPL Execution Flow

```
1. User types â†’ TS Language Service provides completions
2. User hits Enter â†’ Code sent to ai-evaluate worker
3. ai-evaluate executes with sdk: { rpcUrl: targetDO }
4. $ client (capnweb) talks to target DO
5. Result streamed back, pretty-printed
```

## Implementation Components

### CLI Package (cli/)

- `cli/repl/` - Ink-based REPL UI
- `cli/commands/connect.ts` - folder linking
- `cli/commands/generate.ts` - type generation
- `cli/ink/` - Ink components (Header, Input, Output, Autocomplete)

### Type Generation

- Fetch from DO: `GET /.do/types.d.ts`
- Write to: `.do/types.d.ts` in project root
- TypeScript picks up via tsconfig paths or module augmentation

### workers.do Integration

- List workers: `GET /workers` with auth header
- Link folder: `POST /workers/{id}/folders`
- Deploy: existing deploy flow through workers.do

## Dependencies

```json
{
  "oauth.do": "^0.1.15",
  "ink": "^5.0.0",
  "typescript": "^5.0.0",
  "@anthropic-ai/sdk": "for ai-evaluate"
}
```

## Open Questions

1. **workers.do API**: Exact endpoints for listing/linking?
2. **Autocomplete depth**: How much of TS Language Service to embed vs simplify?
