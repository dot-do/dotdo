---
title: Events
description: 5W+H event model with domain event DSL and EPCIS compatibility
---

import { Callout } from 'fumadocs-ui/components/callout'

# Events

Events are the connective tissue of dotdo. Every action, every state change, every business moment is captured as an event. The system uses two complementary models:

1. **Domain Events** - The `$.on` DSL for reactive, code-first event handling
2. **5W+H Events** - A universal schema for storage, querying, and interoperability

```typescript
// Domain events - subscribe to any Noun.verb combination
$.on.Customer.signup(async (event) => {
  await sendWelcomeEmail(event.data.email)
})

// 5W+H events - full context for analytics and audit
{
  actor: 'agent:sally',
  verb: 'signup',
  object: 'Customer/cust-123',
  timestamp: '2024-01-15T10:30:00Z',
  method: 'agentic',
  tools: ['email-finder', 'crm-connector']
}
```

## The Event DSL

The heart of dotdo's event system is the two-level Proxy pattern. No schema definitions, no configuration - just write the event name you want.

### How It Works

```typescript
// $.on is a Proxy
// Accessing .Customer returns another Proxy
// Accessing .signup on that Proxy returns a function
// Calling that function registers your handler

$.on.Customer.signup(handler)
//  ↑    ↑       ↑       ↑
//  │    │       │       └── Handler registration
//  │    │       └────────── Second Proxy (verb access)
//  │    └────────────────── First Proxy (noun access)
//  └─────────────────────── WorkflowContext entry point
```

This pattern enables **infinite Noun.verb combinations**:

```typescript
// All of these work - no setup required
$.on.Customer.signup(handler)
$.on.Payment.failed(handler)
$.on.Inventory.depleted(handler)
$.on.Deployment.completed(handler)
$.on.Experiment.concluded(handler)
$.on.AIModel.trained(handler)
$.on.LiterallyAnything.anyVerb(handler)
```

### Subscribing to Events

```typescript
// Basic subscription
$.on.Order.placed(async (event) => {
  const { orderId, customerId, items } = event.data
  await notifyWarehouse(orderId, items)
  await updateInventory(items)
})

// Multiple handlers for same event
$.on.Payment.completed(async (e) => await trackRevenue(e.data))
$.on.Payment.completed(async (e) => await sendReceipt(e.data))
$.on.Payment.completed(async (e) => await updateReports(e.data))
```

### Wildcards

Pattern matching for cross-cutting concerns:

```typescript
// All 'created' events across all nouns
$.on['*'].created(async (event) => {
  await logCreation(event.source, event.data)
})

// All events for a specific noun
$.on.Customer['*'](async (event) => {
  await trackCustomerActivity(event.verb, event.data)
})

// Global handler - every event
$.on['*']['*'](async (event) => {
  await auditLog(event)
})
```

<Callout type="info">
Specific handlers run before wildcards by default. Use `priority` to change ordering.
</Callout>

### Handler Options

Fine-grained control over event handling:

```typescript
$.on.Order.placed(
  async (event) => {
    await processHighValueOrder(event.data)
  },
  {
    priority: 100,                        // Higher = runs first
    filter: (e) => e.data.total > 1000,   // Conditional execution
    name: 'high-value-handler',           // For debugging
    maxRetries: 5                         // DLQ retry limit
  }
)
```

### Emitting Events

Trigger handlers across the system:

```typescript
// Emit domain events
$.emit.Customer.signup({ id: 'cust-123', email: 'alice@example.com.ai' })
$.emit.Order.shipped({ orderId: 'ord-456', trackingNumber: 'TRK-789' })
$.emit.Invoice.overdue({ invoiceId: 'inv-001', daysOverdue: 30 })
```

---

## 5W+H Event Model

For storage, analytics, and interoperability, events are normalized to the **5W+H** model - answering WHO, WHAT, WHEN, WHERE, WHY, and HOW.

### The Universal Event

| Question | Field(s) | Description |
|----------|----------|-------------|
| **WHO** | actor, source, destination | Who did it |
| **WHAT** | object, type, quantity | What was affected |
| **WHEN** | timestamp, recorded | When it happened |
| **WHERE** | ns, location, readPoint | Where it happened |
| **WHY** | verb, disposition, reason | Why it happened |
| **HOW** | method, branch, model, tools, channel | How it happened |

### Event Schema

```typescript
Event: {
  // WHO - Identity
  actor: string              // User/Agent performing action
  source?: string            // Origin location/system
  destination?: string       // Target location/system

  // WHAT - Objects
  object: string             // Sqid / Thing ID
  type: string               // Noun type
  quantity?: number          // Amount (for countable events)

  // WHEN - Time
  timestamp: datetime        // When it happened (business time)
  recorded: datetime         // When we recorded it (system time)

  // WHERE - Location
  ns: string                 // Namespace (DO identity)
  location?: string          // Physical/logical location
  readPoint?: string         // Capture point (sensor, API, etc.)

  // WHY - Purpose
  verb: string               // Action taken
  disposition?: string       // State after event
  reason?: string            // Business reason

  // HOW - Method
  method?: 'code' | 'generative' | 'agentic' | 'human'
  branch?: string            // Which variant/experiment
  model?: string             // Which AI model (if AI)
  tools?: string[]           // Which tools (if agentic)
  channel?: string           // Which channel (if human)
  cascade?: json             // Cascade path taken
  transaction?: string       // Business transaction ID
  context?: json             // Additional data
}
```

### Domain Event to 5W+H

Domain events are automatically enriched to 5W+H:

```typescript
// You write:
$.emit.Customer.signup({ email: 'alice@example.com.ai' })

// System records:
{
  // WHO
  actor: 'agent:system',
  source: 'https://app.example.com.ai/signup',

  // WHAT
  object: 'Customer/cust-a1b2c3',
  type: 'Customer',

  // WHEN
  timestamp: '2024-01-15T10:30:00Z',
  recorded: '2024-01-15T10:30:00.123Z',

  // WHERE
  ns: 'Signup/main',
  readPoint: 'api/customers',

  // WHY
  verb: 'signup',
  disposition: 'active',

  // HOW
  method: 'code',
  branch: 'main',
  context: { email: 'alice@example.com.ai' }
}
```

---

## Event Flow

```
DO Internal → Events Table → do_events Pipeline → R2 Parquet → /api/search
```

All events flow through a unified pipeline:

1. **DO emits event** - Action completes, event recorded locally in SQLite
2. **Pipeline streams** - Events sent to `do_events` Cloudflare Pipeline
3. **Parquet storage** - Events written to R2 in Parquet format (cold storage)
4. **Query via search** - `/api/search` queries the Parquet tables

### Events Endpoint

The `/e` endpoint accepts events in any format and normalizes to 5W+H:

```typescript
// POST /e - accepts any format, normalizes to 5W+H
export default {
  async fetch(request: Request, env: Env) {
    const body = await request.json()
    const events = normalize(body)  // Detects format
    await env.DO_EVENTS.send(events)
    return Response.json({ ok: true, count: events.length })
  }
}
```

### Supported Formats

The normalizer detects and handles:

- **Internal events** - Native 5W+H format
- **EPCIS events** - GS1 supply chain events
- **Evalite traces** - AI evaluation events
- **Custom formats** - Via registered adapters

---

## EPCIS Compatibility

Our 5W+H model maps 1:1 to [EPCIS 2.0](https://www.gs1.org/epcis), enabling supply chain interoperability:

| 5W+H | EPCIS Field |
|------|-------------|
| WHO | source, destination |
| WHAT | epcList, parentID |
| WHEN | eventTime, recordTime |
| WHERE | readPoint, bizLocation |
| WHY | bizStep, disposition |
| HOW | bizTransaction |

### EPCIS Query Support

Query events using EPCIS query parameters:

```
GET /api/search?eventType=ObjectEvent&bizStep=shipping&MATCH_epc=urn:epc:id:sgtin:...
```

### EPCIS Event Types

| Event Type | Description |
|------------|-------------|
| ObjectEvent | Something happened to objects |
| AggregationEvent | Objects grouped/ungrouped |
| TransactionEvent | Objects linked to business transaction |
| TransformationEvent | Inputs transformed to outputs |
| AssociationEvent | Objects associated/disassociated |

### Digital vs Physical Events

EPCIS was designed for physical supply chains. Our 5W+H model extends this for digital events:

| Physical (EPCIS) | Digital (5W+H) |
|------------------|----------------|
| readPoint: warehouse scanner | readPoint: API endpoint |
| bizLocation: store #123 | ns: app.example.com.ai |
| bizStep: shipping | verb: deployed |
| disposition: in_transit | disposition: active |

---

## Method Tracking

The `method` field captures HOW an action was performed:

| Method | Description | Example |
|--------|-------------|---------|
| `code` | Deterministic code execution | API handler, cron job |
| `generative` | AI text/content generation | Blog post, email draft |
| `agentic` | AI with tool use | Agent researching, coding |
| `human` | Human action | Manual approval, data entry |

```typescript
// Agentic event - AI agent using tools
{
  verb: 'researched',
  object: 'Lead/lead-123',
  method: 'agentic',
  model: 'claude-opus-4-5',
  tools: ['web-search', 'linkedin-api', 'crm-connector'],
  context: {
    query: 'Find decision makers at Acme Corp',
    results: [{ name: 'Jane Smith', title: 'VP Engineering' }]
  }
}

// Generative event - AI generating content
{
  verb: 'drafted',
  object: 'Email/email-456',
  method: 'generative',
  model: 'claude-sonnet-4',
  context: {
    type: 'outreach',
    subject: 'Partnership opportunity',
    body: '...'
  }
}

// Human event - manual action
{
  verb: 'approved',
  object: 'Refund/refund-789',
  method: 'human',
  channel: 'dashboard',
  actor: 'user:alice@example.com.ai',
  reason: 'Customer escalation'
}
```

---

## Evals Integration

Evalite traces are stored as events, enabling:

- **Eval history** - Track all evaluation runs
- **Regression detection** - Compare across model versions
- **Cost analysis** - Track token usage over time

```typescript
// Evalite events flow through same pipeline
{
  type: 'eval',
  verb: 'evaluated',
  object: 'type-classifier',
  branch: 'main',
  model: 'claude-3-5-sonnet',
  context: {
    score: 0.92,
    latency: 1200,
    tokens: { input: 500, output: 100 }
  }
}
```

---

## Related

- [SDK: Events](/docs/sdk/events) - Full event DSL reference
- [WorkflowContext](/docs/sdk/workflow-context) - The $ proxy
- [Sqids](/docs/concepts/sqids) - Entity identification
