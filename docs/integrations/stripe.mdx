---
title: Stripe
description: Drop-in replacement for the Stripe SDK with edge compatibility and local testing support.
---

# Stripe

Drop-in replacement for the Stripe JavaScript SDK. Your existing `stripe` code works unchanged - just swap the import.

```typescript
// Before: Stripe
import Stripe from 'stripe'

// After: dotdo
import { Stripe } from '@dotdo/stripe'

// Code stays the same
const stripe = new Stripe(env.STRIPE_SECRET_KEY)

const customer = await stripe.customers.create({
  email: 'customer@example.com',
  name: 'John Doe',
})

const subscription = await stripe.subscriptions.create({
  customer: customer.id,
  items: [{ price: 'price_xxx' }],
})
```

## Why stripe.do?

| Stripe SDK | @dotdo/stripe |
|------------|---------------|
| Node.js runtime required | Edge-compatible (Cloudflare Workers) |
| Real API calls in tests | Local testing with StripeLocal |
| Network latency | Zero latency in local mode |
| Requires webhook tunnel for dev | Built-in webhook simulation |
| Separate test mode | Same code, different backends |

**This is a proxy/compatibility layer.** It can either forward to real Stripe APIs (production) or run entirely locally for testing and development. The API surface matches Stripe's official SDK.

## Features

### Implemented (Core APIs)

**Customers**
- `create()`, `retrieve()`, `update()`, `del()`, `list()`, `search()`

**Subscriptions**
- `create()`, `retrieve()`, `update()`, `cancel()`, `list()`, `resume()`, `search()`

**Payment Intents**
- `create()`, `retrieve()`, `update()`, `confirm()`, `capture()`, `cancel()`, `list()`, `search()`
- `incrementAuthorization()` for extended auth

**Charges** (legacy)
- `create()`, `retrieve()`, `update()`, `capture()`, `list()`, `search()`

**Refunds**
- `create()`, `retrieve()`, `update()`, `cancel()`, `list()`

**Payment Methods**
- `create()`, `retrieve()`, `update()`, `attach()`, `detach()`, `list()`

**Products & Prices**
- Full CRUD for products and prices
- Lookup keys, recurring prices

**Invoices**
- `create()`, `retrieve()`, `update()`, `del()`, `list()`
- `finalizeInvoice()`, `pay()`, `voidInvoice()`, `markUncollectible()`, `sendInvoice()`
- `retrieveUpcoming()`, `search()`

**Checkout Sessions**
- `create()`, `retrieve()`, `list()`, `listLineItems()`, `expire()`

**Connect (Accounts, Transfers, Payouts)**
- Full account management
- Transfer creation and reversals
- Payout management

**Webhooks**
- `constructEvent()` - Verify and parse webhook events
- `verifySignature()` - Signature validation only
- `generateTestHeaderString()` - Create test signatures

### Not Yet Implemented

- Balance, Balance Transactions
- Disputes
- Files, File Links
- Coupons, Promotion Codes
- Tax Rates
- Radar Rules
- Terminal
- Identity Verification
- Issuing
- Treasury

## Quick Start

### Install

```bash
npm install @dotdo/stripe
```

### Basic Usage

```typescript
import { Stripe } from '@dotdo/stripe'

const stripe = new Stripe(env.STRIPE_SECRET_KEY)

// Create a customer
const customer = await stripe.customers.create({
  email: 'customer@example.com',
  name: 'John Doe',
  metadata: { plan: 'pro' },
})

// Create a payment intent
const paymentIntent = await stripe.paymentIntents.create({
  amount: 2000, // $20.00
  currency: 'usd',
  customer: customer.id,
  automatic_payment_methods: { enabled: true },
})

console.log('Client secret:', paymentIntent.client_secret)
```

## Inbound - Using stripe.do Locally

For testing and development, use `StripeLocal` - a complete in-memory Stripe implementation:

```typescript
import { StripeLocal } from '@dotdo/stripe/local'

// Create local Stripe instance (no API key needed)
const stripe = new StripeLocal()

// Use exactly like real Stripe SDK
const customer = await stripe.customers.create({
  email: 'test@example.com',
})

const paymentIntent = await stripe.paymentIntents.create({
  amount: 2000,
  currency: 'usd',
  customer: customer.id,
})

// Confirm with idempotency
const confirmed = await stripe.paymentIntents.confirm(
  paymentIntent.id,
  {},
  { idempotencyKey: 'unique-key-123' }
)

console.log(confirmed.status) // 'succeeded'
```

### Webhook Events in Local Mode

```typescript
const stripe = new StripeLocal({
  webhooks: true,
  onWebhookEvent: async (event) => {
    console.log('Webhook event:', event.type)
    // Handle event...
  },
})

// Create operations trigger webhook events
const customer = await stripe.customers.create({
  email: 'test@example.com',
})
// onWebhookEvent receives: { type: 'customer.created', data: { object: customer } }
```

### Time-Travel Queries (StripeLocal Extension)

```typescript
const stripe = new StripeLocal()

const customer = await stripe.customers.create({ email: 'v1@example.com' })
const createdAt = Date.now()

await stripe.customers.update(customer.id, { email: 'v2@example.com' })

// Retrieve customer as it was at creation time
const historicalCustomer = await stripe.customers.retrieveAsOf(
  customer.id,
  createdAt
)
console.log(historicalCustomer.email) // 'v1@example.com'
```

### Test Billing Cycles

```typescript
const stripe = new StripeLocal()

const subscription = await stripe.subscriptions.create({
  customer: 'cus_xxx',
  items: [{ price: 'price_monthly' }],
})

// Advance time to trigger billing
stripe.subscriptions.advanceBilling(Date.now() + 30 * 24 * 60 * 60 * 1000)
```

## Outbound - Connecting to Real Stripe

For production, the client connects to Stripe's API:

```typescript
import { Stripe } from '@dotdo/stripe'

const stripe = new Stripe(env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-12-18.acacia',
  maxNetworkRetries: 2,
  timeout: 80000,
})

// All requests go to api.stripe.com
const customer = await stripe.customers.create({
  email: 'customer@example.com',
})
```

### Edge Compatibility

Works in Cloudflare Workers without Node.js dependencies:

```typescript
// worker.ts
import { Stripe } from '@dotdo/stripe'

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const stripe = new Stripe(env.STRIPE_SECRET_KEY)

    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      success_url: 'https://example.com/success',
      cancel_url: 'https://example.com/cancel',
      line_items: [{ price: 'price_xxx', quantity: 1 }],
    })

    return Response.redirect(session.url!)
  },
}
```

### Custom Configuration

```typescript
const stripe = new Stripe('sk_test_xxx', {
  apiVersion: '2024-12-18.acacia', // API version
  maxNetworkRetries: 3,            // Retry count
  timeout: 60000,                  // Request timeout (ms)
  fetch: customFetch,              // Custom fetch implementation
  host: 'api.stripe.com',          // API host override
  protocol: 'https',               // Protocol override
})
```

## Webhooks

### Verifying Webhook Signatures

```typescript
import { Stripe } from '@dotdo/stripe'

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const payload = await request.text()
    const signature = request.headers.get('stripe-signature')!

    try {
      const event = await Stripe.webhooks.constructEvent(
        payload,
        signature,
        env.STRIPE_WEBHOOK_SECRET
      )

      switch (event.type) {
        case 'payment_intent.succeeded':
          const paymentIntent = event.data.object
          console.log('Payment succeeded:', paymentIntent.id)
          break

        case 'customer.subscription.created':
          const subscription = event.data.object
          console.log('New subscription:', subscription.id)
          break

        case 'invoice.paid':
          const invoice = event.data.object
          console.log('Invoice paid:', invoice.id)
          break
      }

      return new Response('OK', { status: 200 })
    } catch (err) {
      console.error('Webhook signature verification failed:', err)
      return new Response('Invalid signature', { status: 400 })
    }
  },
}
```

### Webhook Event Types

```typescript
import type { WebhookEvent, WebhookEventType } from '@dotdo/stripe'

// Common event types
type HandledEvents =
  | 'customer.created'
  | 'customer.updated'
  | 'customer.deleted'
  | 'customer.subscription.created'
  | 'customer.subscription.updated'
  | 'customer.subscription.deleted'
  | 'payment_intent.created'
  | 'payment_intent.succeeded'
  | 'payment_intent.payment_failed'
  | 'charge.succeeded'
  | 'charge.failed'
  | 'charge.refunded'
  | 'invoice.created'
  | 'invoice.paid'
  | 'invoice.payment_failed'
  | 'checkout.session.completed'
```

### Test Webhook Signatures

```typescript
import { Stripe } from '@dotdo/stripe'

const payload = JSON.stringify({
  id: 'evt_test',
  type: 'payment_intent.succeeded',
  // ...
})

const signature = await Stripe.webhooks.generateTestHeaderString({
  payload,
  secret: 'whsec_test',
  timestamp: Math.floor(Date.now() / 1000),
})

// Use in tests
const event = await Stripe.webhooks.constructEvent(
  payload,
  signature,
  'whsec_test'
)
```

## Subscriptions

### Create a Subscription

```typescript
const subscription = await stripe.subscriptions.create({
  customer: 'cus_xxx',
  items: [{ price: 'price_monthly' }],
  payment_behavior: 'default_incomplete',
  payment_settings: { save_default_payment_method: 'on_subscription' },
  expand: ['latest_invoice.payment_intent'],
})
```

### Update Subscription Items

```typescript
const subscription = await stripe.subscriptions.update('sub_xxx', {
  items: [
    { id: 'si_xxx', deleted: true },
    { price: 'price_annual' },
  ],
  proration_behavior: 'create_prorations',
})
```

### Cancel at Period End

```typescript
const subscription = await stripe.subscriptions.update('sub_xxx', {
  cancel_at_period_end: true,
})
```

### Cancel Immediately

```typescript
const subscription = await stripe.subscriptions.cancel('sub_xxx', {
  invoice_now: true,
  prorate: true,
})
```

## Checkout Sessions

### One-Time Payment

```typescript
const session = await stripe.checkout.sessions.create({
  mode: 'payment',
  success_url: 'https://example.com/success?session_id={CHECKOUT_SESSION_ID}',
  cancel_url: 'https://example.com/cancel',
  line_items: [
    {
      price_data: {
        currency: 'usd',
        unit_amount: 2000,
        product_data: { name: 'Premium Widget' },
      },
      quantity: 1,
    },
  ],
})
```

### Subscription Checkout

```typescript
const session = await stripe.checkout.sessions.create({
  mode: 'subscription',
  success_url: 'https://example.com/success',
  cancel_url: 'https://example.com/cancel',
  customer: 'cus_xxx',
  line_items: [{ price: 'price_monthly', quantity: 1 }],
  subscription_data: {
    trial_period_days: 14,
    metadata: { plan: 'pro' },
  },
})
```

## Connect (Multi-Party Payments)

### Create Connected Account

```typescript
const account = await stripe.accounts.create({
  type: 'express',
  country: 'US',
  email: 'seller@example.com',
  capabilities: {
    card_payments: { requested: true },
    transfers: { requested: true },
  },
})
```

### Transfer to Connected Account

```typescript
const transfer = await stripe.transfers.create({
  amount: 1000,
  currency: 'usd',
  destination: 'acct_xxx',
  transfer_group: 'order_123',
})
```

### On-Behalf-Of Requests

```typescript
const paymentIntent = await stripe.paymentIntents.create(
  {
    amount: 2000,
    currency: 'usd',
  },
  { stripeAccount: 'acct_connected' }
)
```

## Request Options

All methods accept optional request options:

```typescript
const customer = await stripe.customers.create(
  { email: 'test@example.com' },
  {
    idempotencyKey: 'unique-request-key',  // Idempotent requests
    stripeAccount: 'acct_xxx',              // Connect account
    apiVersion: '2024-01-01',               // Version override
    maxNetworkRetries: 5,                   // Retry count
    timeout: 30000,                         // Timeout (ms)
  }
)
```

## Error Handling

```typescript
import { Stripe, StripeAPIError } from '@dotdo/stripe'

try {
  await stripe.customers.retrieve('cus_nonexistent')
} catch (error) {
  if (error instanceof StripeAPIError) {
    console.log('Type:', error.type)           // 'invalid_request_error'
    console.log('Code:', error.code)           // 'resource_missing'
    console.log('Message:', error.message)     // 'No such customer...'
    console.log('Status:', error.statusCode)   // 404
    console.log('Param:', error.param)         // 'id'
    console.log('Request ID:', error.requestId)
  }
}
```

### Error Types

| Type | Description |
|------|-------------|
| `api_error` | Stripe API error |
| `card_error` | Card declined or invalid |
| `idempotency_error` | Idempotency key conflict |
| `invalid_request_error` | Invalid parameters |
| `authentication_error` | Invalid API key |
| `rate_limit_error` | Too many requests |

## Types

Full TypeScript support with comprehensive type definitions:

```typescript
import type {
  // Core types
  Customer,
  Subscription,
  PaymentIntent,
  Charge,
  Refund,
  Invoice,
  CheckoutSession,
  Price,
  Product,

  // Connect types
  Account,
  Transfer,
  Payout,

  // Params
  CustomerCreateParams,
  SubscriptionCreateParams,
  PaymentIntentCreateParams,

  // Responses
  ListResponse,
  DeletedObject,

  // Webhooks
  WebhookEvent,
  WebhookEventType,

  // Errors
  StripeError,
  StripeErrorResponse,

  // Utilities
  Metadata,
  Address,
  Shipping,
  RequestOptions,
} from '@dotdo/stripe'
```

## Migration from Stripe SDK

### Package Change

```bash
# Remove
npm uninstall stripe

# Install
npm install @dotdo/stripe
```

### Import Change

```typescript
// Before
import Stripe from 'stripe'
const stripe = new Stripe('sk_test_xxx')

// After (named import)
import { Stripe } from '@dotdo/stripe'
const stripe = new Stripe('sk_test_xxx')

// Or default import
import Stripe from '@dotdo/stripe'
const stripe = new Stripe('sk_test_xxx')
```

### Code Compatibility

Your existing Stripe code should work unchanged:

```typescript
// This code works with both stripe and @dotdo/stripe
const customer = await stripe.customers.create({
  email: 'customer@example.com',
})

const subscription = await stripe.subscriptions.create({
  customer: customer.id,
  items: [{ price: 'price_xxx' }],
})

const paymentIntent = await stripe.paymentIntents.create({
  amount: 2000,
  currency: 'usd',
  customer: customer.id,
})
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Your Application                          │
│                                                              │
│  const stripe = new Stripe(key) // or StripeLocal()         │
│  await stripe.customers.create(...)                          │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│   Production Mode        │     │     Local Mode          │
│   (Stripe)               │     │     (StripeLocal)       │
├─────────────────────────┤     ├─────────────────────────┤
│                         │     │                         │
│  → api.stripe.com       │     │  → In-memory storage    │
│  → Real payments        │     │  → No network calls     │
│  → Live/test keys       │     │  → Webhook simulation   │
│  → Full Stripe API      │     │  → Time-travel queries  │
│                         │     │                         │
└─────────────────────────┘     └─────────────────────────┘
```

### Local Mode Benefits

- **Zero latency**: No network round-trips
- **No API limits**: Unlimited requests
- **Predictable**: No external dependencies
- **Testable**: Control time, simulate failures
- **Offline**: Works without internet

## Common Patterns

### SaaS Subscription Flow

```typescript
import { Stripe } from '@dotdo/stripe'

const stripe = new Stripe(env.STRIPE_SECRET_KEY)

// 1. Create customer on signup
async function createCustomer(email: string, name: string) {
  return stripe.customers.create({ email, name })
}

// 2. Start subscription
async function subscribe(customerId: string, priceId: string) {
  const subscription = await stripe.subscriptions.create({
    customer: customerId,
    items: [{ price: priceId }],
    payment_behavior: 'default_incomplete',
    expand: ['latest_invoice.payment_intent'],
  })

  return {
    subscriptionId: subscription.id,
    clientSecret: (subscription.latest_invoice as any)?.payment_intent?.client_secret,
  }
}

// 3. Handle webhook events
async function handleWebhook(event: WebhookEvent) {
  switch (event.type) {
    case 'customer.subscription.created':
      await activateSubscription(event.data.object.id)
      break
    case 'customer.subscription.deleted':
      await deactivateSubscription(event.data.object.id)
      break
    case 'invoice.payment_failed':
      await notifyPaymentFailure(event.data.object.customer)
      break
  }
}
```

### Metered Billing

```typescript
// Create metered price
const price = await stripe.prices.create({
  currency: 'usd',
  product: 'prod_xxx',
  billing_scheme: 'per_unit',
  recurring: {
    interval: 'month',
    usage_type: 'metered',
  },
  unit_amount: 10, // $0.10 per unit
})

// Report usage
async function reportUsage(subscriptionItemId: string, quantity: number) {
  // Note: Usage records not yet implemented in @dotdo/stripe
  // Use stripe.subscriptionItems.createUsageRecord() when available
}
```

## API Coverage

| Resource | Coverage | Notes |
|----------|----------|-------|
| Customers | Full | All CRUD + search |
| Subscriptions | Full | Including pause/resume |
| Payment Intents | Full | Including incremental auth |
| Charges | Full | Legacy API |
| Refunds | Full | Including cancel |
| Payment Methods | Full | Attach/detach |
| Products | Full | CRUD |
| Prices | Full | One-time and recurring |
| Invoices | Full | Including finalize, pay, void |
| Checkout Sessions | Full | Payment and subscription modes |
| Accounts (Connect) | Full | Express and Custom |
| Transfers | Full | Including reversals |
| Payouts | Full | Including cancel |
| Webhooks | Full | Signature verification |
| Setup Intents | Partial | Types only |
| Coupons | Not yet | |
| Tax Rates | Not yet | |
| Disputes | Not yet | |

## Related

- [Events Overview](/docs/events) - Event handling including webhooks
- [SDK Events](/docs/sdk/events) - Event subscription patterns
- [Compat SDKs](/docs/compat) - All API-compatible SDKs
