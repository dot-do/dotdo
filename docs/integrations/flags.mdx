---
title: Feature Flags
description: LaunchDarkly-compatible feature flags with server-side and edge evaluation.
---

# Feature Flags

LaunchDarkly-compatible feature flag SDK for controlling feature rollouts, A/B testing, and progressive deployments. Runs entirely on the edge with instant flag evaluation.

```typescript
// Before: LaunchDarkly
import * as ld from 'launchdarkly-node-server-sdk'

// After: dotdo
import { LaunchDarkly } from '@dotdo/flags'

// Code stays the same
const client = new LaunchDarkly({ sdkKey: 'sdk-xxx' })
await client.waitForInitialization()

const user = { key: 'user123', email: 'user@example.com' }
const showNewDashboard = await client.variation('new-dashboard', user, false)

if (showNewDashboard) {
  // Show new dashboard
}
```

## Why @dotdo/flags?

| LaunchDarkly | @dotdo/flags |
|--------------|--------------|
| External service dependency | Runs on your edge infrastructure |
| Network latency for evaluation | Instant local evaluation |
| Usage-based pricing | Unlimited evaluations |
| Streaming connection required | Edge-optimized storage |

## Features

### Core Features

- Boolean, string, number, and JSON flags
- Multi-variant flags for A/B testing
- User targeting by attributes
- Percentage rollouts
- Fallback values

### Rule Engine

- Attribute-based targeting
- Segment membership
- Custom targeting rules
- Scheduled rollouts
- Environment targeting

### Integration

- LaunchDarkly SDK compatibility
- REST API for flag management
- Webhook notifications
- Audit logging

## Quick Start

### Install

```bash
npm install @dotdo/flags
```

### Client Usage

```typescript
import { LaunchDarkly } from '@dotdo/flags'

const client = new LaunchDarkly({
  sdkKey: 'sdk-xxx',
  storage: env.FLAGS_KV, // Optional: use KV for persistence
})

await client.waitForInitialization()

// Define a user context
const user = {
  key: 'user123',
  email: 'user@example.com',
  custom: {
    plan: 'premium',
    company: 'Acme Corp',
  },
}

// Evaluate boolean flag
const newFeature = await client.variation('new-feature', user, false)

// Evaluate string flag
const theme = await client.variation('theme', user, 'light')

// Evaluate number flag
const itemLimit = await client.variation('item-limit', user, 10)

// Evaluate JSON flag
const config = await client.variation('app-config', user, { version: 1 })

// Close client when done
await client.close()
```

## Creating Flags

### Using the API

```typescript
import { FlagManager } from '@dotdo/flags'

const manager = new FlagManager({
  storage: env.FLAGS_KV,
})

// Create a boolean flag
await manager.create({
  key: 'new-dashboard',
  name: 'New Dashboard',
  description: 'Enable the new dashboard experience',
  kind: 'boolean',
  variations: [
    { _id: 'true', value: true },
    { _id: 'false', value: false },
  ],
  fallthrough: { variation: 1 }, // Default to false
  offVariation: 1,
  on: true,
})

// Create a multi-variant flag
await manager.create({
  key: 'checkout-experiment',
  name: 'Checkout Experiment',
  kind: 'string',
  variations: [
    { _id: 'control', value: 'control' },
    { _id: 'variant-a', value: 'variant-a' },
    { _id: 'variant-b', value: 'variant-b' },
  ],
  fallthrough: {
    rollout: {
      variations: [
        { variation: 0, weight: 33333 },
        { variation: 1, weight: 33333 },
        { variation: 2, weight: 33334 },
      ],
    },
  },
  on: true,
})
```

### Flag Definition Schema

```typescript
interface FlagDefinition {
  key: string
  name: string
  description?: string
  kind: 'boolean' | 'string' | 'number' | 'json'
  variations: Variation[]
  fallthrough: {
    variation?: number
    rollout?: Rollout
  }
  offVariation?: number
  on: boolean
  rules?: TargetingRule[]
  targets?: Target[]
  prerequisites?: Prerequisite[]
}
```

## Targeting Rules

Target users based on attributes:

```typescript
await manager.create({
  key: 'premium-feature',
  name: 'Premium Feature',
  kind: 'boolean',
  variations: [
    { _id: 'true', value: true },
    { _id: 'false', value: false },
  ],
  rules: [
    // Rule 1: Premium users get the feature
    {
      _id: 'premium-rule',
      clauses: [{
        attribute: 'plan',
        op: 'in',
        values: ['premium', 'enterprise'],
      }],
      variation: 0, // true
    },
    // Rule 2: Beta testers get the feature
    {
      _id: 'beta-rule',
      clauses: [{
        attribute: 'beta_tester',
        op: 'equals',
        values: [true],
      }],
      variation: 0, // true
    },
  ],
  fallthrough: { variation: 1 }, // Default to false
  on: true,
})
```

### Operators

Available operators for targeting rules:

| Operator | Description | Example |
|----------|-------------|---------|
| `in` | Value is in list | `plan in ['premium', 'enterprise']` |
| `equals` | Exact match | `beta_tester equals true` |
| `startsWith` | String starts with | `email startsWith 'admin@'` |
| `endsWith` | String ends with | `email endsWith '@example.com'` |
| `contains` | String contains | `email contains '@internal'` |
| `matches` | Regex match | `email matches '^admin@.*'` |
| `lessThan` | Numeric less than | `age lessThan 18` |
| `lessThanOrEqual` | Numeric less than or equal | `age lessThanOrEqual 18` |
| `greaterThan` | Numeric greater than | `items greaterThan 100` |
| `greaterThanOrEqual` | Numeric greater than or equal | `items greaterThanOrEqual 100` |
| `before` | Date is before | `created before '2024-01-01'` |
| `after` | Date is after | `created after '2024-01-01'` |
| `segmentMatch` | User is in segment | `segmentMatch ['beta-users']` |

## Percentage Rollouts

Gradually roll out features to a percentage of users:

```typescript
await manager.create({
  key: 'new-checkout',
  name: 'New Checkout Flow',
  kind: 'boolean',
  variations: [
    { _id: 'true', value: true },
    { _id: 'false', value: false },
  ],
  fallthrough: {
    rollout: {
      variations: [
        { variation: 0, weight: 10000 },  // 10% get true
        { variation: 1, weight: 90000 },  // 90% get false
      ],
      bucketBy: 'key', // Hash user key for consistent assignment
    },
  },
  on: true,
})
```

### Progressive Rollout

```typescript
// Start with 0%
await manager.update('new-checkout', {
  fallthrough: {
    rollout: {
      variations: [
        { variation: 0, weight: 0 },
        { variation: 1, weight: 100000 },
      ],
    },
  },
})

// Increase to 10%
await manager.update('new-checkout', {
  fallthrough: {
    rollout: {
      variations: [
        { variation: 0, weight: 10000 },
        { variation: 1, weight: 90000 },
      ],
    },
  },
})

// Increase to 50%
await manager.update('new-checkout', {
  fallthrough: {
    rollout: {
      variations: [
        { variation: 0, weight: 50000 },
        { variation: 1, weight: 50000 },
      ],
    },
  },
})

// Full rollout
await manager.update('new-checkout', {
  fallthrough: { variation: 0 },
})
```

## User Targeting

Target specific users by key:

```typescript
await manager.create({
  key: 'beta-feature',
  name: 'Beta Feature',
  kind: 'boolean',
  variations: [
    { _id: 'true', value: true },
    { _id: 'false', value: false },
  ],
  targets: [
    {
      variation: 0, // true
      values: ['user123', 'user456', 'user789'], // Specific user keys
    },
  ],
  fallthrough: { variation: 1 },
  on: true,
})
```

## Segments

Group users into reusable segments:

```typescript
// Create a segment
await manager.createSegment({
  key: 'enterprise-customers',
  name: 'Enterprise Customers',
  included: ['user123', 'user456'],
  excluded: [],
  rules: [{
    clauses: [{
      attribute: 'plan',
      op: 'equals',
      values: ['enterprise'],
    }],
  }],
})

// Use segment in flag rules
await manager.create({
  key: 'enterprise-feature',
  kind: 'boolean',
  variations: [
    { _id: 'true', value: true },
    { _id: 'false', value: false },
  ],
  rules: [{
    _id: 'enterprise-rule',
    clauses: [{
      attribute: '',
      op: 'segmentMatch',
      values: ['enterprise-customers'],
    }],
    variation: 0,
  }],
  fallthrough: { variation: 1 },
  on: true,
})
```

## Evaluating All Flags

Get all flag values for a user:

```typescript
const allFlags = await client.allFlagsState(user)

// Access individual flag values
console.log(allFlags.getValue('new-dashboard'))

// Get metadata
const flagDetails = allFlags.toJSON()
// {
//   'new-dashboard': true,
//   'theme': 'dark',
//   '$valid': true,
//   '$flagsState': { ... }
// }
```

## Streaming Updates

Listen for flag changes:

```typescript
client.on('update', (key) => {
  console.log(`Flag ${key} was updated`)
})

client.on('ready', () => {
  console.log('Client initialized')
})

// Or track specific flags
client.on('update:new-dashboard', (value) => {
  console.log('new-dashboard changed to:', value)
})
```

## REST API

Mount the flag management API:

```typescript
import { createFlagRouter } from '@dotdo/flags'

const app = new Hono()
app.route('/flags', createFlagRouter(env.FLAGS_KV))

// Endpoints:
// GET /flags - List all flags
// POST /flags - Create flag
// GET /flags/:key - Get flag
// PATCH /flags/:key - Update flag
// DELETE /flags/:key - Delete flag
// POST /flags/:key/toggle - Toggle flag on/off
```

## Error Handling

```typescript
import { FlagEvaluationError, FlagNotFoundError } from '@dotdo/flags'

try {
  const value = await client.variation('my-flag', user, false)
} catch (error) {
  if (error instanceof FlagNotFoundError) {
    console.log('Flag not found, using default')
  } else if (error instanceof FlagEvaluationError) {
    console.log('Error evaluating flag:', error.message)
  }
}

// Use variationDetail for more info
const detail = await client.variationDetail('my-flag', user, false)
console.log(detail.value)      // The flag value
console.log(detail.variationIndex)  // Which variation was selected
console.log(detail.reason)     // Why this variation was chosen
```

## API Reference

### LaunchDarkly Class

```typescript
class LaunchDarkly {
  constructor(config: LDConfig)

  waitForInitialization(): Promise<void>
  variation<T>(key: string, user: LDUser, defaultValue: T): Promise<T>
  variationDetail<T>(key: string, user: LDUser, defaultValue: T): Promise<EvaluationDetail<T>>
  allFlagsState(user: LDUser): Promise<AllFlagsState>
  identify(user: LDUser): Promise<void>
  track(eventName: string, user: LDUser, data?: unknown): void
  close(): Promise<void>
}
```

### FlagManager Class

```typescript
class FlagManager {
  constructor(config: FlagManagerConfig)

  list(): Promise<FlagDefinition[]>
  get(key: string): Promise<FlagDefinition | null>
  create(flag: FlagDefinition): Promise<void>
  update(key: string, updates: Partial<FlagDefinition>): Promise<void>
  delete(key: string): Promise<void>
  toggle(key: string): Promise<boolean>
}
```

## Types

```typescript
import type {
  // User types
  LDUser,
  LDUserAttribute,

  // Flag types
  FlagDefinition,
  Variation,
  TargetingRule,
  Clause,
  Rollout,
  Target,

  // Evaluation types
  EvaluationDetail,
  EvaluationReason,
  AllFlagsState,

  // Segment types
  Segment,
  SegmentRule,

  // Config types
  LDConfig,
  FlagManagerConfig,
} from '@dotdo/flags'
```

## Related

- [Analytics](/docs/integrations/analytics) - Track flag evaluations
- [Experiments](/docs/concepts/experiments) - A/B testing and experimentation framework
