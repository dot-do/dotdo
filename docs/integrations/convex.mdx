---
title: Convex
description: Drop-in replacement for Convex browser SDK with edge compatibility and local testing support.
---

# Convex

Drop-in replacement for the Convex browser SDK. Your existing Convex code works unchanged - just swap the import.

```typescript
// Before: Convex
import { ConvexClient } from 'convex/browser'

// After: dotdo
import { ConvexClient } from '@dotdo/convex'

// Code stays the same
const client = new ConvexClient('https://your-deployment.convex.cloud')

// One-shot query
const messages = await client.query(api.messages.list, { channel: 'general' })

// Real-time subscription
const unsubscribe = client.onUpdate(api.messages.list, { channel: 'general' }, (messages) => {
  console.log('Messages:', messages)
})

// Mutation with optimistic update
await client.mutation(api.messages.send, { body: 'Hello!' })
```

## Why @dotdo/convex?

| Convex Cloud | @dotdo/convex |
|--------------|---------------|
| Managed hosting | Self-hosted on your infra |
| Single region latency | Global edge (300+ cities) |
| N/A cold starts | 0ms cold starts |
| Usage-based pricing | Free (your infrastructure) |
| Vendor lock-in | No lock-in |
| Real-time subscriptions | Real-time subscriptions |
| Optimistic updates | Optimistic updates |
| Type-safe queries | Type-safe queries |

**This is a proxy/compatibility layer.** It can run entirely locally on Durable Object SQLite storage (development/testing) or connect to real Convex APIs (production). The API surface matches Convex's official browser SDK.

## Features

### Implemented

**Client API**
- `ConvexClient` - Full browser client API
- `query()` - One-shot queries
- `onUpdate()` - Real-time subscriptions with callbacks
- `mutation()` - Mutations with optimistic updates
- `action()` - Actions for external API calls
- `setAuth()` - Authentication token management
- `sync()` - Wait for pending mutations
- `close()` - Cleanup and resource release

**Generic Table Support**
- Any table name works (not just predefined tables)
- Automatic `_id` generation for new documents
- Automatic `_creationTime` timestamps
- System fields preserved across operations

**Query Operations**
- `list` - Get all documents with optional filtering
- `get` - Get document by ID
- `listBy*` - Filter by field (e.g., `listByAssignee`, `listByAuthor`)
- Pagination with `paginationOpts`
- Numeric comparison filters (`minPriority`, `maxPriority`)

**Mutation Operations**
- `create` / `send` / `insert` - Add new documents
- `update` / `patch` - Modify existing documents
- `remove` / `delete` - Delete documents
- `replace` - Full document replacement
- `increment` - Atomic counter operations

**Optimistic Updates**
- `OptimisticLocalStore` for instant UI updates
- `getQuery()` - Read cached query values
- `setQuery()` - Write optimistic values
- Automatic rollback on mutation failure

**Authentication**
- Token fetcher integration
- Token change callbacks
- Auth context in queries/mutations

### Not Yet Implemented

- Server-side function definitions (`query`, `mutation`, `action` builders)
- Schema validation
- Indexes
- Scheduled functions
- File storage
- HTTP endpoints
- Full-text search

## Installation

```bash
npm install @dotdo/convex
```

## Quick Start

### Create a Client

```typescript
import { ConvexClient } from '@dotdo/convex'

// Default options
const client = new ConvexClient('https://your-deployment.convex.cloud')

// With DO configuration
const client = new ConvexClient('https://your-deployment.convex.cloud', {
  doNamespace: env.CONVEX,
  shard: { key: 'channel', count: 16 },
  replica: { jurisdiction: 'eu', readPreference: 'nearest' },
})
```

### Define Function References

Function references follow the `tableName:operation` pattern:

```typescript
import type { FunctionReference } from '@dotdo/convex'

// Define your API
const api = {
  products: {
    list: { _name: 'products:list' } as FunctionReference<'query'>,
    get: { _name: 'products:get' } as FunctionReference<'query'>,
    create: { _name: 'products:create' } as FunctionReference<'mutation'>,
    update: { _name: 'products:update' } as FunctionReference<'mutation'>,
    remove: { _name: 'products:remove' } as FunctionReference<'mutation'>,
  },
  orders: {
    list: { _name: 'orders:list' } as FunctionReference<'query'>,
    create: { _name: 'orders:create' } as FunctionReference<'mutation'>,
    listByCustomer: { _name: 'orders:listByCustomer' } as FunctionReference<'query'>,
  },
}
```

### One-Shot Queries

```typescript
// List all products
const products = await client.query(api.products.list, {})

// Get product by ID
const product = await client.query(api.products.get, { id: productId })

// Filter by field
const customerOrders = await client.query(api.orders.listByCustomer, {
  customerId: 'cust_123',
})

// Pagination
const page = await client.query(api.products.list, {
  paginationOpts: { numItems: 10, cursor: null },
})
```

### Real-Time Subscriptions

```typescript
// Subscribe to query updates
const unsubscribe = client.onUpdate(
  api.products.list,
  {},
  (products) => {
    console.log('Products updated:', products)
    renderProductList(products)
  }
)

// With error handling
const unsubscribe = client.onUpdate(
  api.products.list,
  {},
  (products) => console.log(products),
  (error) => console.error('Subscription error:', error)
)

// Unsubscribe when done
unsubscribe()
```

### Mutations

```typescript
// Create document
const productId = await client.mutation(api.products.create, {
  name: 'Widget',
  price: 29.99,
  category: 'Electronics',
  inStock: true,
})

// Update document
await client.mutation(api.products.update, {
  id: productId,
  price: 24.99,
  inStock: false,
})

// Delete document
await client.mutation(api.products.remove, { id: productId })
```

### Optimistic Updates

```typescript
await client.mutation(
  api.products.create,
  { name: 'New Product', price: 19.99 },
  {
    optimisticUpdate: (localStore, args) => {
      // Get current cached value
      const existing = localStore.getQuery(api.products.list, {}) ?? []

      // Immediately update with optimistic data
      localStore.setQuery(api.products.list, {}, [
        ...existing,
        {
          _id: 'temp-id',
          _creationTime: Date.now(),
          ...args,
        },
      ])
    },
  }
)
```

### Actions

Actions can call external APIs and perform side effects.

```typescript
// Define action references
const actionApi = {
  openai: {
    chat: { _name: 'openai:chat' } as FunctionReference<'action'>,
    embed: { _name: 'openai:embed' } as FunctionReference<'action'>,
  },
  search: {
    messages: { _name: 'search:messages' } as FunctionReference<'action'>,
  },
}

// Call AI service
const response = await client.action(actionApi.openai.chat, {
  prompt: 'What is the capital of France?',
})

// Search with embeddings
const results = await client.action(actionApi.search.messages, {
  query: 'hello world',
  limit: 10,
})
```

### Authentication

```typescript
// Set auth token fetcher
client.setAuth(async () => {
  return await fetchTokenFromAuth0()
})

// With token change callback
client.setAuth(
  async () => getToken(),
  {
    onTokenChange: (isAuthenticated) => {
      console.log('Auth state:', isAuthenticated)
    },
  }
)

// Clear authentication
client.setAuth(null)
```

## API Reference

### ConvexClient

| Method | Description |
|--------|-------------|
| `new ConvexClient(url, options?)` | Create a new client |
| `client.query(query, args)` | Execute one-shot query |
| `client.onUpdate(query, args, callback, errorCallback?)` | Subscribe to reactive updates |
| `client.mutation(mutation, args, options?)` | Execute mutation |
| `client.action(action, args)` | Execute action |
| `client.setAuth(fetchToken, options?)` | Set authentication |
| `client.sync()` | Wait for pending mutations |
| `client.close()` | Close client and cleanup |

### Client Options

| Option | Type | Description |
|--------|------|-------------|
| `unsavedChangesWarning` | `boolean` | Warn before unload with unsaved changes |
| `skipConvexDeploymentUrlCheck` | `boolean` | Skip URL validation |
| `verbose` | `boolean` | Enable verbose logging |
| `doNamespace` | `DurableObjectNamespace` | DO binding for storage |
| `shard` | `ShardConfig` | Sharding configuration |
| `replica` | `ReplicaConfig` | Replication configuration |

### Mutation Options

| Option | Type | Description |
|--------|------|-------------|
| `optimisticUpdate` | `(localStore, args) => void` | Apply instant UI update |

### OptimisticLocalStore

| Method | Description |
|--------|-------------|
| `getQuery(query, args)` | Get cached query value |
| `setQuery(query, args, value)` | Set cached query value |

## Types

```typescript
import type {
  // Document types
  DocumentId,
  GenericId,
  SystemFields,

  // Function types
  FunctionType,
  FunctionReference,
  FunctionArgs,
  FunctionReturnType,

  // Subscription types
  Unsubscribe,
  SubscriptionCallback,
  ErrorCallback,

  // Optimistic update types
  OptimisticLocalStore,
  OptimisticUpdate,
  MutationOptions,

  // Auth types
  AuthTokenFetcher,
  AuthOptions,

  // Error types
  ConvexError,

  // Pagination types
  PaginationOptions,
  PaginationResult,

  // Client types
  ConvexClientOptions,
  ExtendedConvexConfig,
} from '@dotdo/convex'
```

## Document Types

All documents include system fields:

```typescript
interface Document {
  _id: DocumentId<TableName>  // Unique identifier
  _creationTime: number       // Unix timestamp (ms)
  // ... your fields
}
```

## Function Naming Convention

Functions follow the `tableName:operation` pattern:

```typescript
// Queries
'products:list'        // List all products
'products:get'         // Get product by ID
'products:listByCategory'  // Filter by category

// Mutations
'products:create'      // Create product
'products:update'      // Update product
'products:remove'      // Delete product

// Actions
'openai:chat'          // Call OpenAI API
'search:messages'      // Full-text search
```

## Extended Configuration

### Sharding

```typescript
const client = new ConvexClient(url, {
  shard: {
    algorithm: 'consistent',  // 'consistent' | 'range' | 'hash'
    count: 16,
    key: 'tenantId',          // Shard by tenant field
  },
})
```

### Replication

```typescript
const client = new ConvexClient(url, {
  replica: {
    readPreference: 'nearest',  // 'primary' | 'secondary' | 'nearest'
    writeThrough: true,
    jurisdiction: 'eu',         // 'eu' | 'us' | 'fedramp'
  },
})
```

## Error Handling

```typescript
import type { ConvexError } from '@dotdo/convex'

try {
  await client.mutation(api.products.create, { name: 'Test' })
} catch (error) {
  if ((error as ConvexError).code) {
    const convexError = error as ConvexError
    console.log('Error code:', convexError.code)
    console.log('Error data:', convexError.data)
  }
}
```

## Client Lifecycle

```typescript
const client = new ConvexClient(url)

// Use client...

// Wait for all pending mutations
await client.sync()

// Close and cleanup
await client.close()
```

## Testing

The SDK includes comprehensive tests for all features:

```typescript
import { ConvexClient } from '@dotdo/convex'
import type { FunctionReference } from '@dotdo/convex'

// Create test client
const client = new ConvexClient('https://test.convex.cloud')

// Define test API
const api = {
  products: {
    list: { _name: 'products:list' } as FunctionReference<'query'>,
    create: { _name: 'products:create' } as FunctionReference<'mutation'>,
  },
}

// Test CRUD operations
const id = await client.mutation(api.products.create, { name: 'Test' })
const products = await client.query(api.products.list, {})
expect(products.find(p => p._id === id)).toBeDefined()

// Cleanup
await client.close()
```

## Limitations

- No server-side function definitions (client-only SDK)
- No schema validation (accepts any document structure)
- No file storage (use R2 directly)
- No scheduled functions (use Workers Cron)
- Actions are mocked in local mode

## Related

- [Firebase Integration](/docs/integrations/firebase) - Firebase Firestore alternative
- [Supabase Integration](/docs/integrations/supabase) - Supabase alternative
- [Compat SDKs](/docs/compat) - All API-compatible SDKs
