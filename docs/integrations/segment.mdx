---
title: "Segment"
description: "Drop-in replacement for Analytics.js with edge compatibility and local development mode."
---

# Segment

Drop-in replacement for Segment Analytics.js and Node SDK. Your existing analytics code works unchanged - just swap the import.

```typescript
// Before: Segment
import Analytics from 'analytics-node'

// After: dotdo
import Analytics from '@dotdo/segment'

// Code stays the same
const analytics = new Analytics({ writeKey: 'YOUR_WRITE_KEY' })
analytics.track({ userId: 'user-123', event: 'Order Completed' })
```

## Prerequisites

Before integrating Segment with dotdo, you need:

### 1. Segment Workspace

1. Sign up at [segment.com](https://segment.com)
2. Create a workspace

### 2. Create a Source

1. In your workspace, go to **Connections** > **Sources**
2. Add a **Node.js** source
3. Copy the **Write Key**

### 3. Environment Setup

Store your write key securely:

```bash
SEGMENT_WRITE_KEY=your_write_key_here
```

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `SEGMENT_WRITE_KEY` | Yes (production) | Segment source write key |

## Why @dotdo/segment?

| analytics-node | @dotdo/segment |
|----------------|----------------|
| Node.js runtime required | Edge-compatible (Cloudflare Workers) |
| Always sends to Segment | Local mode for testing |
| External dependency | Works offline |
| No type safety | Full TypeScript support |

**This is a compatibility layer.** It can either forward events to real Segment APIs (production) or buffer events locally for testing and development.

## Features

### Implemented

**Core Analytics**
- `track()` - Track events
- `identify()` - Identify users
- `page()` - Track page views
- `screen()` - Track screen views (mobile)
- `group()` - Associate users with groups
- `alias()` - Link user identities

**Advanced**
- Batching and flushing
- Automatic retry with backoff
- Offline queuing
- Context enrichment
- Integrations control

### Not Yet Implemented

- Live debugger
- Privacy controls
- Consent management

## Quick Start

### Install

```bash
npm install @dotdo/segment
```

### Basic Usage

```typescript
import Analytics from '@dotdo/segment'

const analytics = new Analytics({
  writeKey: process.env.SEGMENT_WRITE_KEY,
})

// Identify user
analytics.identify({
  userId: 'user-123',
  traits: {
    email: 'user@example.com',
    name: 'John Doe',
    plan: 'premium',
  },
})

// Track events
analytics.track({
  userId: 'user-123',
  event: 'Order Completed',
  properties: {
    orderId: 'order-456',
    total: 99.99,
    currency: 'USD',
    products: [
      { id: 'product-1', name: 'Widget', price: 49.99 },
      { id: 'product-2', name: 'Gadget', price: 50.00 },
    ],
  },
})

// Track page views
analytics.page({
  userId: 'user-123',
  category: 'Docs',
  name: 'Getting Started',
  properties: {
    url: 'https://docs.example.com/start',
    referrer: 'https://google.com',
  },
})

// Flush all pending events
await analytics.flush()
```

### Groups

```typescript
import Analytics from '@dotdo/segment'

const analytics = new Analytics({ writeKey: process.env.SEGMENT_WRITE_KEY })

// Associate user with a company/group
analytics.group({
  userId: 'user-123',
  groupId: 'company-456',
  traits: {
    name: 'Acme Inc',
    industry: 'Technology',
    employees: 100,
    plan: 'enterprise',
  },
})
```

## Configuration

### Client Options

```typescript
import Analytics, { type AnalyticsConfig } from '@dotdo/segment'

const config: AnalyticsConfig = {
  // Required
  writeKey: 'YOUR_WRITE_KEY',

  // Batching
  flushAt: 20,           // Flush after this many events
  flushInterval: 10000,  // Flush after this many ms (default: 10s)

  // Networking
  maxRetries: 3,         // Max retry attempts
  timeout: 30000,        // Request timeout in ms

  // Optional: Custom host
  host: 'https://api.segment.io',
}

const analytics = new Analytics(config)
```

## Inbound - Local Development

For local development and testing, events are buffered locally:

```typescript
import Analytics from '@dotdo/segment'

// Create analytics instance
const analytics = new Analytics({
  writeKey: 'test-key',
  // Events are queued but not sent in test mode
})

// Track events locally
analytics.track({
  userId: 'test-user',
  event: 'Test Event',
})

// In tests, you can inspect the queue
// Events are stored but not sent to Segment
```

## Outbound - Production

For production, events are sent to Segment:

```typescript
// worker.ts
import Analytics from '@dotdo/segment'

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const analytics = new Analytics({ writeKey: env.SEGMENT_WRITE_KEY })

    // Parse request for user context
    const userId = request.headers.get('x-user-id')

    // Track page view
    analytics.page({
      userId,
      name: 'API Request',
      properties: {
        path: new URL(request.url).pathname,
        method: request.method,
      },
    })

    // Important: Flush before response
    await analytics.flush()

    return new Response('OK')
  },
}
```

## Context Enrichment

Add automatic context to all events:

```typescript
import Analytics from '@dotdo/segment'

const analytics = new Analytics({ writeKey: process.env.SEGMENT_WRITE_KEY })

// Track with context
analytics.track({
  userId: 'user-123',
  event: 'Button Clicked',
  properties: {
    button: 'Sign Up',
  },
  context: {
    ip: request.headers.get('cf-connecting-ip'),
    userAgent: request.headers.get('user-agent'),
    locale: request.headers.get('accept-language'),
    page: {
      url: request.url,
      referrer: request.headers.get('referer'),
    },
    campaign: {
      source: 'google',
      medium: 'cpc',
      name: 'spring-sale',
    },
  },
})
```

## Integration Control

Control which destinations receive events:

```typescript
import Analytics from '@dotdo/segment'

const analytics = new Analytics({ writeKey: process.env.SEGMENT_WRITE_KEY })

// Enable only specific integrations
analytics.track({
  userId: 'user-123',
  event: 'Sensitive Action',
  integrations: {
    All: false,              // Disable all by default
    Amplitude: true,         // Enable Amplitude
    'Google Analytics': true, // Enable GA
  },
})
```

## Error Handling

```typescript
import Analytics from '@dotdo/segment'

const analytics = new Analytics({
  writeKey: process.env.SEGMENT_WRITE_KEY,
})

// With callback
analytics.track({
  userId: 'user-123',
  event: 'Test Event',
}, (err) => {
  if (err) {
    console.error('Failed to track:', err.message)
  }
})

// With try/catch
try {
  await analytics.flush()
} catch (error) {
  console.error('Failed to flush events:', error)
}
```

## TypeScript Types

Full TypeScript support:

```typescript
import type {
  // Core types
  AnalyticsConfig,
  TrackParams,
  IdentifyParams,
  PageParams,
  GroupParams,
  AliasParams,

  // Context
  Context,
  Campaign,
  Page,

  // Integrations
  Integrations,
} from '@dotdo/segment'
```

## Workflow Integration

Use Segment with dotdo workflows for durable analytics:

```typescript
import { $ } from 'dotdo'
import Analytics from '@dotdo/segment'

export class OrderProcessor {
  analytics = new Analytics({ writeKey: this.env.SEGMENT_WRITE_KEY })

  async processOrder(order: Order) {
    // Durable event tracking
    await $.do(() => {
      this.analytics.track({
        userId: order.userId,
        event: 'Order Completed',
        properties: {
          orderId: order.id,
          total: order.total,
          products: order.items,
        },
      })
      return this.analytics.flush()
    })
  }
}
```

## Migration from analytics-node

### 1. Package Change

```bash
# Remove analytics-node
npm uninstall analytics-node

# Install dotdo package
npm install @dotdo/segment
```

### 2. Import Change

```typescript
// Before
import Analytics from 'analytics-node'

// After
import Analytics from '@dotdo/segment'
```

### 3. Code Compatibility

Your existing code should work unchanged. The API surface matches analytics-node.

## Related

- [Mixpanel Integration](/docs/integrations/mixpanel) - Mixpanel analytics
- [Amplitude Integration](/docs/integrations/amplitude) - Amplitude analytics
- [Compat SDKs Overview](/docs/compat) - All API-compatible SDKs
