# =============================================================================
# Docker Compose for DuckDB WASM Build
# =============================================================================
#
# Provides build variants and development environments for DuckDB WASM.
#
# Usage:
#   docker-compose run --rm release       # Build release
#   docker-compose run --rm debug         # Build debug
#   docker-compose run --rm size          # Build size-optimized
#   docker-compose run --rm shell         # Interactive shell
#

services:
  # Base builder service
  builder:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DUCKDB_VERSION: ${DUCKDB_VERSION:-v1.1.3}
    volumes:
      - ./dist:/output
      - ccache:/ccache
    environment:
      - CCACHE_DIR=/ccache

  # Release build
  release:
    extends: builder
    command: ["--release"]

  # Debug build with symbols
  debug:
    extends: builder
    command: ["--debug"]

  # Size-optimized build
  size:
    extends: builder
    command: ["--size"]

  # Interactive shell for debugging
  shell:
    extends: builder
    entrypoint: /bin/bash
    stdin_open: true
    tty: true

  # Build and test in one step
  test:
    extends: builder
    command: ["--release"]
    volumes:
      - ./dist:/output
      - ./test:/test
      - ccache:/ccache

# Persistent cache for faster rebuilds
volumes:
  ccache:
    driver: local
